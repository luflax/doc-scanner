import{r as e,j as t}from"./react-vendor-DmQDSmdE.js";import{F as a,u as s,D as n,B as r,S as i}from"./camera-BcjNYq1x.js";import{i as l,g as o}from"./services-B0EPmGK0.js";import{v as c}from"./vendor-DsI9Cwdy.js";import"./zustand-vendor-CAwqQeLl.js";import"./db-vendor-7JQXQzuE.js";import"./zip-vendor-BnyUYtAy.js";import"./tesseract-vendor-C8JZVqR3.js";import"./pdf-vendor-kgbuHCKQ.js";const d=({selectedFilter:s,onSelect:n,disabled:r=!1})=>{const i=e.useRef(null),l=e.useRef(null);return e.useEffect(()=>{l.current&&i.current&&l.current.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"})},[s]),t.jsx("div",{className:"w-full bg-white border-b border-gray-200",children:t.jsx("div",{ref:i,className:"flex gap-2 px-4 py-3 overflow-x-auto scrollbar-hide",style:{scrollSnapType:"x mandatory",WebkitOverflowScrolling:"touch"},children:a.map(e=>{const a=e.id===s;return t.jsxs("button",{ref:a?l:null,onClick:()=>!r&&n(e.id),disabled:r,className:`\n                flex-shrink-0 flex flex-col items-center justify-center\n                min-w-[80px] px-3 py-2 rounded-lg\n                transition-all duration-200\n                ${a?"bg-blue-500 text-white shadow-md scale-105":"bg-gray-100 text-gray-700 hover:bg-gray-200"}\n                ${r?"opacity-50 cursor-not-allowed":"cursor-pointer"}\n                scroll-snap-align-center\n              `,style:{scrollSnapAlign:"center"},children:[t.jsx("span",{className:"text-2xl mb-1",children:e.icon}),t.jsx("span",{className:"text-xs font-medium text-center leading-tight",children:e.name})]},e.id)})})})},m=({label:e,value:a,min:s,max:n,step:r,onChange:i,disabled:l=!1,unit:o=""})=>{const c=(a-s)/(n-s)*100;return t.jsxs("div",{className:"mb-4",children:[t.jsxs("div",{className:"flex justify-between items-center mb-2",children:[t.jsx("label",{className:"text-sm font-medium text-gray-700",children:e}),t.jsxs("span",{className:"text-sm text-gray-500",children:[a.toFixed(r<1?1:0),o]})]}),t.jsx("div",{className:"relative",children:t.jsx("input",{type:"range",min:s,max:n,step:r,value:a,onChange:e=>i(parseFloat(e.target.value)),disabled:l,className:`\n            w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer\n            ${l?"opacity-50 cursor-not-allowed":""}\n          `,style:{background:`linear-gradient(to right, #3b82f6 0%, #3b82f6 ${c}%, #e5e7eb ${c}%, #e5e7eb 100%)`}})})]})},g=({options:e,onChange:a,disabled:s=!1})=>{const n=(t,s)=>{a({...e,[t]:s})};return t.jsxs("div",{className:"bg-white p-4 rounded-lg",children:[t.jsx("h3",{className:"text-sm font-semibold text-gray-800 mb-4",children:"Manual Adjustments"}),t.jsx(m,{label:"Brightness",value:e.brightness,min:-100,max:100,step:1,onChange:e=>n("brightness",e),disabled:s}),t.jsx(m,{label:"Contrast",value:e.contrast,min:-100,max:100,step:1,onChange:e=>n("contrast",e),disabled:s}),t.jsx(m,{label:"Saturation",value:e.saturation,min:-100,max:100,step:1,onChange:e=>n("saturation",e),disabled:s}),t.jsx(m,{label:"Gamma",value:e.gamma,min:.1,max:3,step:.1,onChange:e=>n("gamma",e),disabled:s}),t.jsx("button",{onClick:()=>a({brightness:0,contrast:0,saturation:0,sharpness:0,gamma:1,shadows:0,highlights:0,temperature:0}),disabled:s,className:"w-full mt-2 px-4 py-2 text-sm text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:"Reset Adjustments"})]})},h=()=>{const a=e.useRef(null),[m,h]=e.useState(!1),[u,x]=e.useState(null),[p,b]=e.useState(!1),{currentImage:f,processedImage:j,adjustedCorners:w,selectedFilter:v,enhancementOptions:y,setCurrentView:N,setSelectedFilter:S,setEnhancementOptions:C,addDocument:F,resetScanSession:E,addToast:I}=s(e=>({currentImage:e.scanSession.currentImage,processedImage:e.scanSession.processedImage,adjustedCorners:e.scanSession.adjustedCorners,selectedFilter:e.scanSession.selectedFilter,enhancementOptions:e.scanSession.enhancementOptions,setCurrentView:e.setCurrentView,setSelectedFilter:e.setSelectedFilter,setEnhancementOptions:e.setEnhancementOptions,addDocument:e.addDocument,resetScanSession:e.resetScanSession,addToast:e.addToast}));e.useEffect(()=>{j&&!u&&(x(j),k(j))},[j]),e.useEffect(()=>{j&&D(v)},[v]),e.useEffect(()=>{u&&A(y)&&O()},[y]);const k=e=>{if(!a.current)return;const t=a.current,s=t.getContext("2d");s&&(t.width=e.width,t.height=e.height,s.putImageData(e,0,0))},D=async e=>{if(j){h(!0);try{const t=await l.applyFilter(j,e);t?(x(t),k(t),C(n)):I({type:"error",message:"Failed to apply filter"})}catch(t){I({type:"error",message:"Filter application failed"})}finally{h(!1)}}},O=async()=>{if(u){h(!0);try{let e=j;if("original"!==v&&(e=await l.applyFilter(j,v)),!e)throw new Error("Failed to get base image");const t=await l.enhance(e,y);t?(x(t),k(t)):I({type:"error",message:"Failed to apply adjustments"})}catch(e){}finally{h(!1)}}},A=e=>0!==e.brightness||0!==e.contrast||0!==e.saturation||1!==e.gamma;return j?t.jsxs("div",{className:"flex flex-col h-full bg-gray-900",children:[t.jsxs("div",{className:"flex-1 overflow-hidden flex items-center justify-center p-4 relative",children:[t.jsx("canvas",{ref:a,className:"max-w-full max-h-full object-contain shadow-2xl"}),m&&t.jsx("div",{className:"absolute inset-0 bg-black/50 flex items-center justify-center",children:t.jsxs("div",{className:"bg-white rounded-lg p-4 flex items-center gap-3",children:[t.jsx(i,{size:"sm"}),t.jsx("span",{className:"text-sm text-gray-700",children:"Processing..."})]})})]}),t.jsx(d,{selectedFilter:v,onSelect:e=>{S(e)},disabled:m}),t.jsx("div",{className:"bg-white border-t border-gray-200 px-4 py-2",children:t.jsxs("button",{onClick:()=>b(!p),className:"w-full flex items-center justify-between text-sm font-medium text-gray-700 hover:text-gray-900",children:[t.jsx("span",{children:"Manual Adjustments"}),t.jsx("span",{className:"text-lg",children:p?"▼":"▶"})]})}),p&&t.jsx("div",{className:"bg-gray-50 border-t border-gray-200 max-h-80 overflow-y-auto",children:t.jsx(g,{options:y,onChange:e=>{C(e)},disabled:m})}),t.jsx("div",{className:"p-4 bg-white border-t border-gray-200",children:t.jsxs("div",{className:"flex gap-3",children:[t.jsx(r,{onClick:()=>N("crop"),variant:"secondary",fullWidth:!0,disabled:m,children:"Back"}),t.jsx(r,{onClick:async()=>{if(u&&f){h(!0);try{const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("Failed to get canvas context");e.width=u.width,e.height=u.height,t.putImageData(u,0,0);const a=await new Promise((t,a)=>{e.toBlob(e=>{e?t(e):a(new Error("Failed to convert canvas to blob"))},"image/png")}),s=document.createElement("canvas"),n=s.getContext("2d");if(!n)throw new Error("Failed to get canvas context");s.width=f.width,s.height=f.height,n.putImageData(f,0,0);const r=await new Promise((e,t)=>{s.toBlob(a=>{a?e(a):t(new Error("Failed to convert canvas to blob"))},"image/png")}),i=document.createElement("canvas"),l=i.getContext("2d");if(!l)throw new Error("Failed to get canvas context");const d=300,m=Math.min(d/u.width,d/u.height);i.width=u.width*m,i.height=u.height*m,l.drawImage(e,0,0,i.width,i.height);const g=await new Promise((e,t)=>{i.toBlob(a=>{a?e(a):t(new Error("Failed to convert canvas to blob"))},"image/jpeg",.8)}),h={id:c(),pageNumber:1,originalImage:r,processedImage:a,thumbnailImage:g,corners:w||[],enhancementSettings:y,filterApplied:v,dimensions:{width:u.width,height:u.height}},x=new Date,p=`Document ${x.toLocaleDateString()} ${x.toLocaleTimeString()}`,b={id:c(),name:p,createdAt:x,updatedAt:x,pages:[h],tags:[],metadata:{totalPages:1,hasOCR:!1,fileSize:a.size,source:"camera"}},j=await o();await j.createDocument(b),F(b),E(),I({type:"success",message:"Document saved successfully"}),N("documents")}catch(e){I({type:"error",message:"Failed to save document"})}finally{h(!1)}}else I({type:"error",message:"No image to save"})},variant:"primary",fullWidth:!0,disabled:m,children:"Save Document"})]})})]}):t.jsxs("div",{className:"flex flex-col items-center justify-center h-full bg-gray-50 p-6",children:[t.jsx("p",{className:"text-gray-600",children:"No image to enhance"}),t.jsx(r,{onClick:()=>N("camera"),className:"mt-4",children:"Back to Camera"})]})};export{h as EnhanceView};
