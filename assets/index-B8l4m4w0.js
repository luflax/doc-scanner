var ze=Object.defineProperty;var Ae=(i,e,t)=>e in i?ze(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var A=(i,e,t)=>Ae(i,typeof e!="symbol"?e+"":e,t);import{r as b,a as ke,R as Le}from"./react-vendor-CVDnmApk.js";import{c as Be}from"./zustand-vendor-D0NwXheU.js";import{s as _e}from"./tesseract-vendor-h9Ea91i4.js";import{E as Ve}from"./pdf-vendor-CzmxGYVW.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(r){if(r.ep)return;r.ep=!0;const n=t(r);fetch(r.href,n)}})();var De={exports:{}},ae={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ge=b,$e=Symbol.for("react.element"),Ue=Symbol.for("react.fragment"),We=Object.prototype.hasOwnProperty,He=Ge.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Ye={key:!0,ref:!0,__self:!0,__source:!0};function Ie(i,e,t){var s,r={},n=null,o=null;t!==void 0&&(n=""+t),e.key!==void 0&&(n=""+e.key),e.ref!==void 0&&(o=e.ref);for(s in e)We.call(e,s)&&!Ye.hasOwnProperty(s)&&(r[s]=e[s]);if(i&&i.defaultProps)for(s in e=i.defaultProps,e)r[s]===void 0&&(r[s]=e[s]);return{$$typeof:$e,type:i,key:n,ref:o,props:r,_owner:He.current}}ae.Fragment=Ue;ae.jsx=Ie;ae.jsxs=Ie;De.exports=ae;var a=De.exports,he={},we=ke;he.createRoot=we.createRoot,he.hydrateRoot=we.hydrateRoot;const se={brightness:0,contrast:0,saturation:0,sharpness:0,gamma:1,shadows:0,highlights:0,temperature:0},qe=[{id:"original",name:"Original",description:"No filter applied",icon:"ðŸ“„"},{id:"document",name:"Document",description:"High contrast B&W",icon:"ðŸ“ƒ"},{id:"grayscale",name:"Grayscale",description:"Black and white",icon:"â¬œ"},{id:"magic",name:"Magic",description:"Auto-enhanced",icon:"âœ¨"},{id:"whiteboard",name:"Whiteboard",description:"For whiteboards",icon:"ðŸ–Šï¸"},{id:"book",name:"Book",description:"For book pages",icon:"ðŸ“–"},{id:"receipt",name:"Receipt",description:"High contrast",icon:"ðŸ§¾"},{id:"photo",name:"Photo",description:"Color preserved",icon:"ðŸ–¼ï¸"},{id:"blueprint",name:"Blueprint",description:"Inverted colors",icon:"ðŸ“"}],L=Be(i=>({camera:{isInitialized:!1,isCapturing:!1,stream:null,capabilities:null,error:null},scanSession:{isActive:!1,currentImage:null,detectedEdges:null,adjustedCorners:null,processedImage:null,selectedFilter:"original",enhancementOptions:se},ocr:{isInitialized:!1,isProcessing:!1,progress:0,result:null,selectedLanguages:["eng"]},documents:{list:[],currentDocument:null,isLoading:!1},ui:{currentView:"camera",isProcessing:!1,toasts:[],modalOpen:null},setCameraInitialized:e=>i(t=>({camera:{...t.camera,isInitialized:e}})),setCameraStream:e=>i(t=>({camera:{...t.camera,stream:e}})),setCameraCapabilities:e=>i(t=>({camera:{...t.camera,capabilities:e}})),setCameraError:e=>i(t=>({camera:{...t.camera,error:e}})),setCapturing:e=>i(t=>({camera:{...t.camera,isCapturing:e}})),startScanSession:e=>i({scanSession:{isActive:!0,currentImage:e,detectedEdges:null,adjustedCorners:null,processedImage:null,selectedFilter:"original",enhancementOptions:se}}),setDetectedEdges:e=>i(t=>({scanSession:{...t.scanSession,detectedEdges:e}})),setAdjustedCorners:e=>i(t=>({scanSession:{...t.scanSession,adjustedCorners:e}})),setProcessedImage:e=>i(t=>({scanSession:{...t.scanSession,processedImage:e}})),setSelectedFilter:e=>i(t=>({scanSession:{...t.scanSession,selectedFilter:e}})),setEnhancementOptions:e=>i(t=>({scanSession:{...t.scanSession,enhancementOptions:e}})),resetScanSession:()=>i({scanSession:{isActive:!1,currentImage:null,detectedEdges:null,adjustedCorners:null,processedImage:null,selectedFilter:"original",enhancementOptions:se}}),setOCRInitialized:e=>i(t=>({ocr:{...t.ocr,isInitialized:e}})),setOCRProcessing:e=>i(t=>({ocr:{...t.ocr,isProcessing:e}})),setOCRProgress:e=>i(t=>({ocr:{...t.ocr,progress:e}})),setOCRResult:e=>i(t=>({ocr:{...t.ocr,result:e}})),setSelectedLanguages:e=>i(t=>({ocr:{...t.ocr,selectedLanguages:e}})),setDocuments:e=>i(t=>({documents:{...t.documents,list:e}})),setCurrentDocument:e=>i(t=>({documents:{...t.documents,currentDocument:e}})),setDocumentsLoading:e=>i(t=>({documents:{...t.documents,isLoading:e}})),addDocument:e=>i(t=>({documents:{...t.documents,list:[e,...t.documents.list]}})),removeDocument:e=>i(t=>({documents:{...t.documents,list:t.documents.list.filter(s=>s.id!==e)}})),setCurrentView:e=>i(t=>({ui:{...t.ui,currentView:e}})),setProcessing:e=>i(t=>({ui:{...t.ui,isProcessing:e}})),addToast:e=>i(t=>({ui:{...t.ui,toasts:[...t.ui.toasts,{...e,id:Math.random().toString(36).substr(2,9)}]}})),removeToast:e=>i(t=>({ui:{...t.ui,toasts:t.ui.toasts.filter(s=>s.id!==e)}})),setModalOpen:e=>i(t=>({ui:{...t.ui,modalOpen:e}}))})),Xe=()=>{const i=L(t=>t.ui.currentView),e=()=>{switch(i){case"camera":return"Document Scanner";case"crop":return"Crop Document";case"enhance":return"Enhance";case"ocr":return"Extract Text";case"documents":return"My Documents";case"export":return"Export";default:return"Document Scanner"}};return a.jsx("header",{className:"fixed top-0 left-0 right-0 z-30 bg-white border-b border-gray-200 pt-safe",children:a.jsxs("div",{className:"flex items-center justify-between px-4 h-14",children:[a.jsx("h1",{className:"text-lg font-semibold text-gray-900",children:e()}),a.jsx("div",{className:"flex items-center gap-2"})]})})},Ke=()=>{const i=L(s=>s.ui.currentView),e=L(s=>s.setCurrentView),t=[{view:"camera",label:"Camera",icon:"ðŸ“·"},{view:"documents",label:"Documents",icon:"ðŸ“„"}];return a.jsx("nav",{className:"fixed bottom-0 left-0 right-0 z-30 bg-white border-t border-gray-200 pb-safe",children:a.jsx("div",{className:"flex items-center justify-around h-16",children:t.map(s=>a.jsxs("button",{onClick:()=>e(s.view),className:`flex flex-col items-center justify-center flex-1 h-full transition-colors ${i===s.view?"text-primary-600":"text-gray-500 hover:text-gray-700"}`,children:[a.jsx("span",{className:"text-2xl mb-1",children:s.icon}),a.jsx("span",{className:"text-xs font-medium",children:s.label})]},s.view))})})},Ze=({toast:i})=>{const e=L(s=>s.removeToast);b.useEffect(()=>{const s=i.duration||3e3,r=setTimeout(()=>{e(i.id)},s);return()=>clearTimeout(r)},[i.id,i.duration,e]);const t={success:"toast-success",error:"toast-error",warning:"toast-warning",info:"toast-info"};return a.jsx("div",{className:`toast ${t[i.type]} mb-2`,children:a.jsx("p",{className:"text-sm font-medium",children:i.message})})},Je=()=>{const i=L(e=>e.ui.toasts);return i.length===0?null:a.jsx("div",{className:"fixed top-4 right-4 z-50 space-y-2",children:i.map(e=>a.jsx(Ze,{toast:e},e.id))})};class Qe{constructor(){A(this,"stream",null);A(this,"videoTrack",null);A(this,"currentFacingMode","environment")}async initialize(e){const s={...{facingMode:"environment",resolution:{ideal:{width:3840,height:2160},min:{width:1920,height:1080}},focusMode:"continuous",torch:!1},...e};this.currentFacingMode=s.facingMode;try{const r={video:{facingMode:{ideal:s.facingMode},width:{ideal:s.resolution.ideal.width},height:{ideal:s.resolution.ideal.height}},audio:!1};return this.stream=await navigator.mediaDevices.getUserMedia(r),this.videoTrack=this.stream.getVideoTracks()[0],this.stream}catch(r){console.warn("Failed with ideal constraints, falling back to basic",r);const n={video:{facingMode:s.facingMode,width:{ideal:1920},height:{ideal:1080}},audio:!1};return this.stream=await navigator.mediaDevices.getUserMedia(n),this.videoTrack=this.stream.getVideoTracks()[0],this.stream}}getCapabilities(){if(!this.videoTrack)return null;try{const e=this.videoTrack.getCapabilities();return{hasFlash:"torch"in e,hasFocus:"focusMode"in e,hasZoom:"zoom"in e,maxZoom:e.zoom?.max||1,supportedResolutions:this.getSupportedResolutions(e)}}catch(e){return console.error("Failed to get camera capabilities",e),{hasFlash:!1,hasFocus:!1,hasZoom:!1,maxZoom:1,supportedResolutions:[]}}}getSupportedResolutions(e){const t=[],s=[{width:3840,height:2160},{width:1920,height:1080},{width:1280,height:720},{width:640,height:480}],r=e.width?.max||1920,n=e.height?.max||1080;for(const o of s)o.width<=r&&o.height<=n&&t.push(o);return t}async switchCamera(){const e=this.currentFacingMode==="environment"?"user":"environment";return this.dispose(),this.initialize({facingMode:e})}async capturePhoto(e){if(!this.stream)throw new Error("Camera not initialized");const t=document.createElement("canvas");t.width=e.videoWidth,t.height=e.videoHeight;const s=t.getContext("2d");if(!s)throw new Error("Failed to get canvas context");return s.drawImage(e,0,0),s.getImageData(0,0,t.width,t.height)}getVideoFrame(e){if(!this.stream)return null;try{const t=document.createElement("canvas"),s=Math.min(640,e.videoWidth),r=Math.min(480,e.videoHeight);t.width=s,t.height=r;const n=t.getContext("2d");return n?(n.drawImage(e,0,0,s,r),n.getImageData(0,0,s,r)):null}catch(t){return console.error("Failed to get video frame",t),null}}async setZoom(e){if(!this.videoTrack)throw new Error("Camera not initialized");if(!("zoom"in this.videoTrack.getCapabilities()))throw new Error("Zoom not supported");const s={advanced:[{zoom:e}]};try{await this.videoTrack.applyConstraints(s)}catch(r){throw console.error("Failed to set zoom",r),r}}async toggleFlash(e){if(!this.videoTrack)throw new Error("Camera not initialized");if(!("torch"in this.videoTrack.getCapabilities()))throw new Error("Flash not supported");const s={advanced:[{torch:e}]};try{await this.videoTrack.applyConstraints(s)}catch(r){throw console.error("Failed to toggle flash",r),r}}async setFocusPoint(e,t){if(!this.videoTrack)throw new Error("Camera not initialized");if(!("focusMode"in this.videoTrack.getCapabilities())){console.warn("Focus control not supported");return}console.log("Focus point requested:",e,t)}getStream(){return this.stream}getCurrentFacingMode(){return this.currentFacingMode}isInitialized(){return this.stream!==null&&this.videoTrack!==null}dispose(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.videoTrack=null}}const $=new Qe,et=(i={})=>{const{autoStart:e=!1,facingMode:t="environment",onError:s,onInitialized:r}=i,[n,o]=b.useState(null),[l,c]=b.useState(!1),[d,m]=b.useState(!1),[g,C]=b.useState(null),[j,E]=b.useState(null),h=b.useRef(null),u=async()=>{m(!0),C(null);try{const f=await $.initialize({facingMode:t});o(f),c(!0);const N=$.getCapabilities();E(N),r?.(f)}catch(f){const N=f instanceof Error?f:new Error("Failed to initialize camera");C(N),s?.(N)}finally{m(!1)}},y=async()=>{m(!0),C(null);try{const f=await $.switchCamera();o(f);const N=$.getCapabilities();E(N),r?.(f)}catch(f){const N=f instanceof Error?f:new Error("Failed to switch camera");C(N),s?.(N)}finally{m(!1)}},S=async()=>{if(!h.current||!n)return C(new Error("Camera not ready")),null;try{return await $.capturePhoto(h.current)}catch(f){const N=f instanceof Error?f:new Error("Failed to capture photo");return C(N),s?.(N),null}},F=async f=>{try{await $.setZoom(f)}catch(N){console.error("Zoom failed:",N)}},v=async f=>{try{await $.toggleFlash(f)}catch(N){console.error("Flash toggle failed:",N)}},x=()=>{$.dispose(),o(null),c(!1),E(null)};return b.useEffect(()=>{n&&h.current&&(h.current.srcObject=n)},[n]),b.useEffect(()=>(e&&u(),()=>{x()}),[]),{stream:n,isInitialized:l,isLoading:d,error:g,capabilities:j,videoRef:h,initialize:u,switchCamera:y,capturePhoto:S,setZoom:F,toggleFlash:v,dispose:x,facingMode:$.getCurrentFacingMode()}},P=({variant:i="primary",size:e="md",fullWidth:t=!1,className:s="",children:r,...n})=>{const o="btn font-medium transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed",l={primary:"btn-primary",secondary:"btn-secondary",outline:"border-2 border-primary-600 text-primary-600 hover:bg-primary-50 active:bg-primary-100"},c={sm:"px-3 py-1.5 text-sm",md:"px-4 py-2 text-base",lg:"px-6 py-3 text-lg"},d=t?"w-full":"";return a.jsx("button",{className:`${o} ${l[i]} ${c[e]} ${d} ${s}`,...n,children:r})},me=({icon:i,label:e,size:t="md",className:s="",...r})=>{const n={sm:"p-2",md:"p-3",lg:"p-4"};return a.jsx("button",{className:`btn-icon ${n[t]} ${s}`,"aria-label":e,title:e,...r,children:i})},q=({size:i="md",className:e=""})=>{const t={sm:"w-4 h-4",md:"w-8 h-8",lg:"w-12 h-12"};return a.jsx("div",{className:`flex items-center justify-center ${e}`,children:a.jsx("div",{className:`${t[i]} border-4 border-gray-200 border-t-primary-600 rounded-full animate-spin`})})},ve=()=>{const{addToast:i,setCameraCapabilities:e,setCurrentView:t,startScanSession:s}=L(h=>({addToast:h.addToast,setCameraCapabilities:h.setCameraCapabilities,setCurrentView:h.setCurrentView,startScanSession:h.startScanSession})),{videoRef:r,isInitialized:n,isLoading:o,error:l,capabilities:c,facingMode:d,initialize:m,switchCamera:g,capturePhoto:C}=et({onError:h=>{i({type:"error",message:h.message||"Failed to access camera"})},onInitialized:()=>{i({type:"success",message:"Camera initialized successfully"})}});b.useEffect(()=>{c&&e(c)},[c,e]);const j=async()=>{const h=await C();h&&(s(h),t("crop"),i({type:"success",message:"Image captured successfully"}))},E=async()=>{try{await g(),i({type:"success",message:`Switched to ${d==="environment"?"front":"back"} camera`})}catch{i({type:"error",message:"Failed to switch camera"})}};return o?a.jsxs("div",{className:"flex flex-col items-center justify-center h-full bg-black",children:[a.jsx(q,{size:"lg",className:"mb-4"}),a.jsx("p",{className:"text-white text-sm",children:"Initializing camera..."})]}):l||!n&&!o?a.jsxs("div",{className:"flex flex-col items-center justify-center h-full bg-gray-100 p-6",children:[a.jsx("div",{className:"text-6xl mb-4",children:"ðŸ“·"}),a.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Camera Access Required"}),l&&a.jsx("p",{className:"text-sm text-red-600 mb-4 text-center max-w-md",children:l.message}),a.jsx("p",{className:"text-sm text-gray-600 mb-6 text-center max-w-md",children:"This app needs access to your camera to scan documents. Click the button below to grant permission."}),a.jsx(P,{onClick:m,variant:"primary",size:"lg",children:"Enable Camera"})]}):a.jsxs("div",{className:"relative w-full h-full bg-black",children:[a.jsx("video",{ref:r,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover"}),a.jsx("div",{className:"absolute top-0 left-0 right-0 p-4",children:a.jsx("div",{className:"flex justify-end",children:a.jsx(me,{icon:a.jsx("span",{className:"text-xl",children:"ðŸ”„"}),onClick:E,className:"bg-black/50 text-white hover:bg-black/70",label:"Switch camera"})})}),a.jsx("div",{className:"absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/80 to-transparent",children:a.jsx("div",{className:"flex items-center justify-center",children:a.jsx(P,{onClick:j,variant:"primary",size:"lg",className:"rounded-full w-16 h-16 p-0",children:a.jsx("span",{className:"text-2xl",children:"ðŸ“¸"})})})}),a.jsx("div",{className:"absolute inset-0 pointer-events-none",children:a.jsx("div",{className:"w-full h-full flex items-center justify-center p-8",children:a.jsx("div",{className:"border-2 border-white border-dashed rounded-lg w-full max-w-md aspect-document opacity-50"})})})]})},tt=({corners:i,imageSize:e,containerSize:t,onChange:s,onCommit:r,className:n=""})=>{const[o,l]=b.useState(null),[c,d]=b.useState(i),m=b.useRef(null);b.useEffect(()=>{d(i)},[i]);const g=()=>{const v=e.width/e.height,x=t.width/t.height;let f,N,D=0,p=0;return v>x?(f=t.width/e.width,N=f,p=(t.height-e.height*N)/2):(N=t.height/e.height,f=N,D=(t.width-e.width*f)/2),{scaleX:f,scaleY:N,offsetX:D,offsetY:p}},C=v=>{const{scaleX:x,scaleY:f,offsetX:N,offsetY:D}=g();return{x:v.x*x+N,y:v.y*f+D}},j=v=>{const{scaleX:x,scaleY:f,offsetX:N,offsetY:D}=g();return{x:(v.x-N)/x,y:(v.y-D)/f}},E=v=>{if(!m.current)return{x:0,y:0};const f=m.current.getBoundingClientRect();let N,D;if("touches"in v){const p=v.touches[0];N=p.clientX,D=p.clientY}else N=v.clientX,D=v.clientY;return{x:N-f.left,y:D-f.top}},h=v=>x=>{x.preventDefault(),x.stopPropagation(),l(v)},u=v=>{if(o===null)return;v.preventDefault();const x=E(v),f=j(x),N={x:Math.max(0,Math.min(e.width,f.x)),y:Math.max(0,Math.min(e.height,f.y))},D=[...c];D[o]=N,d(D),s(D)},y=()=>{o!==null&&(l(null),r?.())},S=c.map(C),F=S.length===4?`M ${S[0].x} ${S[0].y} L ${S[1].x} ${S[1].y} L ${S[2].x} ${S[2].y} L ${S[3].x} ${S[3].y} Z`:"";return a.jsxs("svg",{ref:m,className:`absolute inset-0 w-full h-full ${n}`,style:{touchAction:"none"},onMouseMove:u,onMouseUp:y,onMouseLeave:y,onTouchMove:u,onTouchEnd:y,onTouchCancel:y,children:[F&&a.jsxs(a.Fragment,{children:[a.jsx("path",{d:F,fill:"rgba(59, 130, 246, 0.2)",stroke:"none"}),a.jsx("path",{d:F,fill:"none",stroke:"#3b82f6",strokeWidth:"2"})]}),S.map((v,x)=>a.jsxs("g",{children:[a.jsx("circle",{cx:v.x,cy:v.y,r:"20",fill:"transparent",style:{cursor:"grab"},onMouseDown:h(x),onTouchStart:h(x)}),a.jsx("circle",{cx:v.x,cy:v.y,r:"8",fill:"white",stroke:"#3b82f6",strokeWidth:"3",style:{cursor:"grab",pointerEvents:"none"}}),a.jsx("circle",{cx:v.x,cy:v.y,r:"3",fill:"#3b82f6",style:{pointerEvents:"none"}})]},x)),S.length===4&&S.map((v,x)=>{const f=S[(x+1)%4];return a.jsx("line",{x1:v.x,y1:v.y,x2:f.x,y2:f.y,stroke:"#3b82f6",strokeWidth:"2",strokeDasharray:"5,5",style:{pointerEvents:"none"}},`line-${x}`)})]})};let J=!1;function st(){return window.__opencvLoadPromise?window.__opencvLoadPromise:J&&window.cv?Promise.resolve(window.cv):(window.__opencvLoadPromise=new Promise((i,e)=>{window.__resolvePromise=i,window.__rejectPromise=e,window.Module=window.Module||{};const t=window.Module.onRuntimeInitialized;window.Module.onRuntimeInitialized=()=>{try{J=!0,console.log("[loadOpenCV] Module.onRuntimeInitialized fired"),window.__resolvePromise(window.cv)}catch(r){console.error("[loadOpenCV] error resolving promise",r),window.__rejectPromise(r)}};const s=document.createElement("script");s.async=!0,s.src="https://docs.opencv.org/4.8.0/opencv.js",s.onload=()=>{if(console.log("[loadOpenCV] script.onload executed; window.cv=",!!window.cv),window.cv&&window.cv.Mat)try{J?console.log("[loadOpenCV] already marked loaded"):(J=!0,console.log("[loadOpenCV] cv.Mat present on load â€” resolving immediately"),window.__resolvePromise(window.cv))}catch(r){console.error("[loadOpenCV] error resolving onload",r),window.__rejectPromise(r)}},s.onerror=r=>{console.error("[loadOpenCV] script.onerror",r),window.__opencvLoadPromise=null,t&&(window.Module.onRuntimeInitialized=t),window.__rejectPromise(new Error("Failed to load OpenCV.js script"))},document.body.appendChild(s)}),window.__opencvLoadPromise.catch(i=>{console.error("[loadOpenCV] promise rejected",i)}),window.__opencvLoadPromise)}function fe(){return!!window.cv}function re(){if(!window.cv)throw new Error("OpenCV not loaded. Call loadOpenCV() first.");return window.cv}function B(i){return re().matFromImageData(i)}function V(i){const e=re(),t=document.createElement("canvas");t.width=i.cols,t.height=i.rows;const s=t.getContext("2d");if(!s)throw new Error("Failed to get canvas context");return e.imshow(t,i),s.getImageData(0,0,t.width,t.height)}function _(...i){for(const e of i)e&&e.delete&&e.delete()}class rt{constructor(){A(this,"cv",null);A(this,"isInitialized",!1)}async initialize(){if(console.log("[EdgeDetectionService] initialize() called, isInitialized:",this.isInitialized),!this.isInitialized)try{console.log("[EdgeDetectionService] Calling loadOpenCV()"),this.cv=window.cv instanceof Promise?await window.cv:window.cv,console.log("[EdgeDetectionService] loadOpenCV() completed, cv:",this.cv),this.isInitialized=!0,console.log("[EdgeDetectionService] EdgeDetectionService initialized")}catch(e){throw console.error("[EdgeDetectionService] Failed to initialize EdgeDetectionService:",e),e}}async detectDocument(e,t){console.log("[EdgeDetectionService] detectDocument() called, image size:",e.width,"x",e.height),this.isInitialized||(console.log("[EdgeDetectionService] Not initialized, calling initialize()"),await this.initialize());const r={...{cannyThreshold1:50,cannyThreshold2:150,blurKernelSize:5,dilationIterations:2,minAreaRatio:.1,maxAreaRatio:.95},...t};let n=null,o=null,l=null,c=null,d=null,m=null,g=null;try{console.log("[EdgeDetectionService] Starting edge detection pipeline"),console.log("[EdgeDetectionService] Converting ImageData to Mat"),n=B(e),console.log("[EdgeDetectionService] ImageData converted, Mat size:",n.rows,"x",n.cols),console.log("[EdgeDetectionService] Converting to grayscale"),o=new this.cv.Mat,this.cv.cvtColor(n,o,this.cv.COLOR_RGBA2GRAY),console.log("[EdgeDetectionService] Grayscale conversion complete"),console.log("[EdgeDetectionService] Applying Gaussian blur"),l=new this.cv.Mat;const C=new this.cv.Size(r.blurKernelSize,r.blurKernelSize);this.cv.GaussianBlur(o,l,C,0),console.log("[EdgeDetectionService] Gaussian blur complete"),console.log("[EdgeDetectionService] Applying Canny edge detection"),c=new this.cv.Mat,this.cv.Canny(l,c,r.cannyThreshold1,r.cannyThreshold2),console.log("[EdgeDetectionService] Canny edge detection complete"),console.log("[EdgeDetectionService] Dilating edges"),d=new this.cv.Mat;const j=this.cv.Mat.ones(3,3,this.cv.CV_8U);this.cv.dilate(c,d,j,new this.cv.Point(-1,-1),r.dilationIterations),j.delete(),console.log("[EdgeDetectionService] Edge dilation complete"),console.log("[EdgeDetectionService] Finding contours"),m=new this.cv.MatVector,g=new this.cv.Mat,this.cv.findContours(d,m,g,this.cv.RETR_EXTERNAL,this.cv.CHAIN_APPROX_SIMPLE),console.log("[EdgeDetectionService] Found",m.size(),"contours"),console.log("[EdgeDetectionService] Finding best quadrilateral");const E=this.findBestQuadrilateral(m,e.width,e.height,r);return console.log("[EdgeDetectionService] Best quadrilateral result:",E),E}catch(C){return console.error("[EdgeDetectionService] Edge detection failed:",C),null}finally{console.log("[EdgeDetectionService] Cleaning up resources"),_(n,o,l,c,d,g),m&&m.delete(),console.log("[EdgeDetectionService] Cleanup complete")}}findBestQuadrilateral(e,t,s,r){const n=t*s,o=n*r.minAreaRatio,l=n*r.maxAreaRatio;let c=null,d=0;for(let m=0;m<e.size();m++){const g=e.get(m),C=this.cv.contourArea(g);if(C<o||C>l)continue;const j=this.cv.arcLength(g,!0),E=new this.cv.Mat;if(this.cv.approxPolyDP(g,E,.02*j,!0),E.rows===4){const h=this.matToPoints(E),u=this.getBoundingRect(h),y=u.width/u.height,S=this.scoreQuadrilateral(h,C,y,n);S>d&&(d=S,c={contour:this.orderCorners(h),confidence:Math.min(S/100,1),area:C,aspectRatio:y,boundingRect:u})}E.delete()}return c}scoreQuadrilateral(e,t,s,r){let n=0;const o=t/r;n+=o*50;const c=[1,1.29,1.41,1.5].reduce((m,g)=>{const C=Math.abs(s-g),j=Math.max(0,25-C*20);return Math.max(m,j)},0);n+=c;const d=this.isRoughlyConvex(e)?25:0;return n+=d,n}isRoughlyConvex(e){if(e.length!==4)return!1;const t=[];for(let n=0;n<4;n++){const o=e[n],l=e[(n+1)%4],c=e[(n+2)%4],d=(l.x-o.x)*(c.y-l.y)-(l.y-o.y)*(c.x-l.x);t.push(d)}const s=t.every(n=>n>0),r=t.every(n=>n<0);return s||r}matToPoints(e){const t=[];for(let s=0;s<e.rows;s++){const r=e.data32S[s*2],n=e.data32S[s*2+1];t.push({x:r,y:n})}return t}getBoundingRect(e){const t=e.map(c=>c.x),s=e.map(c=>c.y),r=Math.min(...t),n=Math.max(...t),o=Math.min(...s),l=Math.max(...s);return{x:r,y:o,width:n-r,height:l-o}}orderCorners(e){if(e.length!==4)return e;const t=[...e].sort((n,o)=>n.y-o.y),s=t.slice(0,2).sort((n,o)=>n.x-o.x),r=t.slice(2,4).sort((n,o)=>n.x-o.x);return[s[0],s[1],r[1],r[0]]}isReady(){return this.isInitialized&&fe()}}const nt=new rt;class at{async correctPerspective(e,t,s){if(!fe())throw new Error("OpenCV not loaded");if(t.length!==4)throw new Error("Exactly 4 corners required");const n={...{outputWidth:0,outputHeight:0,preserveAspectRatio:!0,interpolation:"linear"},...s};let o=null,l=null,c=null;try{const d=re();o=B(e);const m=n.outputWidth&&n.outputHeight?{width:n.outputWidth,height:n.outputHeight}:this.calculateOutputDimensions(t),g=this.ensureCornerOrder(t),C=d.matFromArray(4,1,d.CV_32FC2,[g[0].x,g[0].y,g[1].x,g[1].y,g[2].x,g[2].y,g[3].x,g[3].y]),j=d.matFromArray(4,1,d.CV_32FC2,[0,0,m.width,0,m.width,m.height,0,m.height]);c=d.getPerspectiveTransform(C,j),l=new d.Mat;const E=new d.Size(m.width,m.height),h=this.getInterpolationFlag(n.interpolation);d.warpPerspective(o,l,c,E,h,d.BORDER_CONSTANT,new d.Scalar(255,255,255,255));const u=V(l),y=this.matrixToArray(c);return C.delete(),j.delete(),{correctedImage:u,transformMatrix:y,originalCorners:g,outputDimensions:m}}catch(d){return console.error("Perspective correction failed:",d),null}finally{_(o,l,c)}}calculateOutputDimensions(e){if(e.length!==4)throw new Error("Exactly 4 corners required");const t=this.ensureCornerOrder(e),s=this.distance(t[0],t[1]),r=this.distance(t[3],t[2]),n=this.distance(t[0],t[3]),o=this.distance(t[1],t[2]),l=Math.max(s,r),c=Math.max(n,o);return{width:Math.round(l),height:Math.round(c)}}distance(e,t){const s=t.x-e.x,r=t.y-e.y;return Math.sqrt(s*s+r*r)}ensureCornerOrder(e){if(e.length!==4)return e;const t={x:e.reduce((l,c)=>l+c.x,0)/4,y:e.reduce((l,c)=>l+c.y,0)/4},s=[...e].sort((l,c)=>{const d=Math.atan2(l.y-t.y,l.x-t.x),m=Math.atan2(c.y-t.y,c.x-t.x);return d-m}),r=s.map(l=>l.x+l.y),n=r.indexOf(Math.min(...r));return[s[n],s[(n+1)%4],s[(n+2)%4],s[(n+3)%4]]}getInterpolationFlag(e){const t=re();switch(e){case"nearest":return t.INTER_NEAREST;case"linear":return t.INTER_LINEAR;case"cubic":return t.INTER_CUBIC;case"lanczos":return t.INTER_LANCZOS4;default:return t.INTER_LINEAR}}matrixToArray(e){const t=[];for(let s=0;s<e.rows;s++){const r=[];for(let n=0;n<e.cols;n++)r.push(e.data64F[s*e.cols+n]);t.push(r)}return t}}const it=new at,ot=()=>{const i=b.useRef(null),e=b.useRef(null),[t,s]=b.useState(!1),[r,n]=b.useState(!1),[o,l]=b.useState({width:0,height:0}),{currentImage:c,detectedEdges:d,adjustedCorners:m,setCurrentView:g,resetScanSession:C,setDetectedEdges:j,setAdjustedCorners:E,setProcessedImage:h,addToast:u}=L(x=>({currentImage:x.scanSession.currentImage,detectedEdges:x.scanSession.detectedEdges,adjustedCorners:x.scanSession.adjustedCorners,setCurrentView:x.setCurrentView,resetScanSession:x.resetScanSession,setDetectedEdges:x.setDetectedEdges,setAdjustedCorners:x.setAdjustedCorners,setProcessedImage:x.setProcessedImage,addToast:x.addToast}));b.useEffect(()=>{if(c&&i.current){const x=i.current,f=x.getContext("2d");if(!f)return;x.width=c.width,x.height=c.height,f.putImageData(c,0,0)}},[c]),b.useEffect(()=>{c&&!d&&!t&&y()},[c]),b.useEffect(()=>{const x=()=>{if(e.current){const f=e.current.getBoundingClientRect();l({width:f.width,height:f.height})}};return x(),window.addEventListener("resize",x),()=>window.removeEventListener("resize",x)},[]);const y=async()=>{if(console.log("[CropView] detectEdges() called"),!!c){console.log("[CropView] Setting isDetecting to true"),s(!0);try{console.log("[CropView] Calling edgeDetectionService.detectDocument()");const x=await nt.detectDocument(c);if(console.log("[CropView] detectDocument() returned:",x),x)j(x),E(x.contour),u({type:"success",message:"Document detected!"});else{const f=[{x:0,y:0},{x:c.width,y:0},{x:c.width,y:c.height},{x:0,y:c.height}];E(f),u({type:"warning",message:"Could not detect document. Using full image."})}}catch(x){console.error("[CropView] Edge detection failed:",x),u({type:"error",message:"Edge detection failed"})}finally{console.log("[CropView] Setting isDetecting to false"),s(!1)}}},S=x=>{E(x)},F=()=>{C(),g("camera")},v=async()=>{if(!(!c||!m)){n(!0);try{const x=await it.correctPerspective(c,m);if(x)h(x.correctedImage),g("enhance"),u({type:"success",message:"Image cropped successfully!"});else throw new Error("Perspective correction failed")}catch(x){console.error("Perspective correction failed:",x),u({type:"error",message:"Failed to crop image"})}finally{n(!1)}}};return c?t?a.jsxs("div",{className:"flex flex-col items-center justify-center h-full bg-gray-900",children:[a.jsx(q,{size:"lg",className:"mb-4"}),a.jsx("p",{className:"text-white text-sm",children:"Detecting document edges..."})]}):a.jsxs("div",{className:"flex flex-col h-full bg-gray-900",children:[a.jsxs("div",{ref:e,className:"flex-1 overflow-hidden flex items-center justify-center p-4 relative",children:[a.jsx("canvas",{ref:i,className:"max-w-full max-h-full object-contain"}),m&&c&&o.width>0&&a.jsx(tt,{corners:m,imageSize:{width:c.width,height:c.height},containerSize:o,onChange:S})]}),a.jsx("div",{className:"p-4 bg-white border-t border-gray-200",children:a.jsxs("div",{className:"flex gap-3",children:[a.jsx(P,{onClick:F,variant:"secondary",fullWidth:!0,disabled:r,children:"Retake"}),a.jsx(P,{onClick:y,variant:"secondary",fullWidth:!0,disabled:r,children:"Auto-Detect"}),a.jsx(P,{onClick:v,variant:"primary",fullWidth:!0,disabled:r,children:r?"Processing...":"Continue"})]})})]}):a.jsxs("div",{className:"flex flex-col items-center justify-center h-full bg-gray-50 p-6",children:[a.jsx("p",{className:"text-gray-600",children:"No image captured"}),a.jsx(P,{onClick:()=>g("camera"),className:"mt-4",children:"Back to Camera"})]})};let Q;const ct=new Uint8Array(16);function lt(){if(!Q&&(Q=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Q))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Q(ct)}const T=[];for(let i=0;i<256;++i)T.push((i+256).toString(16).slice(1));function dt(i,e=0){return T[i[e+0]]+T[i[e+1]]+T[i[e+2]]+T[i[e+3]]+"-"+T[i[e+4]]+T[i[e+5]]+"-"+T[i[e+6]]+T[i[e+7]]+"-"+T[i[e+8]]+T[i[e+9]]+"-"+T[i[e+10]]+T[i[e+11]]+T[i[e+12]]+T[i[e+13]]+T[i[e+14]]+T[i[e+15]]}const ut=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Ce={randomUUID:ut};function je(i,e,t){if(Ce.randomUUID&&!i)return Ce.randomUUID();i=i||{};const s=i.random||(i.rng||lt)();return s[6]=s[6]&15|64,s[8]=s[8]&63|128,dt(s)}const ht=({selectedFilter:i,onSelect:e,disabled:t=!1})=>{const s=b.useRef(null),r=b.useRef(null);return b.useEffect(()=>{r.current&&s.current&&r.current.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"})},[i]),a.jsx("div",{className:"w-full bg-white border-b border-gray-200",children:a.jsx("div",{ref:s,className:"flex gap-2 px-4 py-3 overflow-x-auto scrollbar-hide",style:{scrollSnapType:"x mandatory",WebkitOverflowScrolling:"touch"},children:qe.map(n=>{const o=n.id===i;return a.jsxs("button",{ref:o?r:null,onClick:()=>!t&&e(n.id),disabled:t,className:`
                flex-shrink-0 flex flex-col items-center justify-center
                min-w-[80px] px-3 py-2 rounded-lg
                transition-all duration-200
                ${o?"bg-blue-500 text-white shadow-md scale-105":"bg-gray-100 text-gray-700 hover:bg-gray-200"}
                ${t?"opacity-50 cursor-not-allowed":"cursor-pointer"}
                scroll-snap-align-center
              `,style:{scrollSnapAlign:"center"},children:[a.jsx("span",{className:"text-2xl mb-1",children:n.icon}),a.jsx("span",{className:"text-xs font-medium text-center leading-tight",children:n.name})]},n.id)})})})},ee=({label:i,value:e,min:t,max:s,step:r,onChange:n,disabled:o=!1,unit:l=""})=>{const c=(e-t)/(s-t)*100;return a.jsxs("div",{className:"mb-4",children:[a.jsxs("div",{className:"flex justify-between items-center mb-2",children:[a.jsx("label",{className:"text-sm font-medium text-gray-700",children:i}),a.jsxs("span",{className:"text-sm text-gray-500",children:[e.toFixed(r<1?1:0),l]})]}),a.jsx("div",{className:"relative",children:a.jsx("input",{type:"range",min:t,max:s,step:r,value:e,onChange:d=>n(parseFloat(d.target.value)),disabled:o,className:`
            w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer
            ${o?"opacity-50 cursor-not-allowed":""}
          `,style:{background:`linear-gradient(to right, #3b82f6 0%, #3b82f6 ${c}%, #e5e7eb ${c}%, #e5e7eb 100%)`}})})]})},mt=({options:i,onChange:e,disabled:t=!1})=>{const s=(r,n)=>{e({...i,[r]:n})};return a.jsxs("div",{className:"bg-white p-4 rounded-lg",children:[a.jsx("h3",{className:"text-sm font-semibold text-gray-800 mb-4",children:"Manual Adjustments"}),a.jsx(ee,{label:"Brightness",value:i.brightness,min:-100,max:100,step:1,onChange:r=>s("brightness",r),disabled:t}),a.jsx(ee,{label:"Contrast",value:i.contrast,min:-100,max:100,step:1,onChange:r=>s("contrast",r),disabled:t}),a.jsx(ee,{label:"Saturation",value:i.saturation,min:-100,max:100,step:1,onChange:r=>s("saturation",r),disabled:t}),a.jsx(ee,{label:"Gamma",value:i.gamma,min:.1,max:3,step:.1,onChange:r=>s("gamma",r),disabled:t}),a.jsx("button",{onClick:()=>e({brightness:0,contrast:0,saturation:0,sharpness:0,gamma:1,shadows:0,highlights:0,temperature:0}),disabled:t,className:"w-full mt-2 px-4 py-2 text-sm text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:"Reset Adjustments"})]})};class gt{constructor(){A(this,"cv",null);A(this,"isInitialized",!1)}async initialize(){if(!this.isInitialized)try{this.cv=await st(),this.isInitialized=!0,console.log("ImageEnhancementService initialized")}catch(e){throw console.error("Failed to initialize ImageEnhancementService:",e),e}}async enhance(e,t){this.isInitialized||await this.initialize();let s=null,r=null;try{if(s=B(e),r=s.clone(),t.brightness!==0||t.contrast!==0){const n=1+t.contrast/100,o=t.brightness/100*255;r.convertTo(r,-1,n,o)}return t.gamma!==1&&this.applyGamma(r,t.gamma),t.saturation!==0&&this.applySaturation(r,t.saturation),V(r)}catch(n){return console.error("Enhancement failed:",n),null}finally{_(s,r)}}async applyFilter(e,t){switch(this.isInitialized||await this.initialize(),t){case"original":return e;case"grayscale":return this.applyGrayscale(e);case"document":return this.applyDocumentFilter(e);case"magic":return this.applyMagicFilter(e);case"whiteboard":return this.applyWhiteboardFilter(e);case"book":return this.applyBookFilter(e);case"receipt":return this.applyReceiptFilter(e);case"photo":return this.applyPhotoFilter(e);case"blueprint":return this.applyBlueprintFilter(e);default:return e}}applyGrayscale(e){let t=null,s=null,r=null;try{return t=B(e),s=new this.cv.Mat,this.cv.cvtColor(t,s,this.cv.COLOR_RGBA2GRAY),r=new this.cv.Mat,this.cv.cvtColor(s,r,this.cv.COLOR_GRAY2RGBA),r.convertTo(r,-1,1.1,5),V(r)}catch(n){return console.error("Grayscale filter failed:",n),null}finally{_(t,s,r)}}applyDocumentFilter(e){let t=null,s=null,r=null,n=null,o=null;try{return t=B(e),s=new this.cv.Mat,this.cv.cvtColor(t,s,this.cv.COLOR_RGBA2GRAY),r=new this.cv.Mat,this.cv.fastNlMeansDenoising(s,r,10,7,21),n=new this.cv.Mat,this.cv.adaptiveThreshold(r,n,255,this.cv.ADAPTIVE_THRESH_GAUSSIAN_C,this.cv.THRESH_BINARY,11,2),o=new this.cv.Mat,this.cv.cvtColor(n,o,this.cv.COLOR_GRAY2RGBA),V(o)}catch(l){return console.error("Document filter failed:",l),null}finally{_(t,s,r,n,o)}}applyMagicFilter(e){let t=null,s=null,r=null,n=null,o=null;try{t=B(e),s=new this.cv.Mat,this.cv.cvtColor(t,s,this.cv.COLOR_RGBA2RGB),this.cv.cvtColor(s,s,this.cv.COLOR_RGB2Lab),r=new this.cv.MatVector,this.cv.split(s,r),n=r.get(0);const l=new this.cv.CLAHE(2,new this.cv.Size(8,8));return l.apply(n,n),this.cv.merge(r,s),o=new this.cv.Mat,this.cv.cvtColor(s,o,this.cv.COLOR_Lab2RGB),this.cv.cvtColor(o,o,this.cv.COLOR_RGB2RGBA),o.convertTo(o,-1,1.1,0),r.delete(),l.delete(),V(o)}catch(l){return console.error("Magic filter failed:",l),null}finally{_(t,s,n,o)}}applyWhiteboardFilter(e){let t=null,s=null,r=null,n=null,o=null;try{return t=B(e),s=new this.cv.Mat,this.cv.cvtColor(t,s,this.cv.COLOR_RGBA2GRAY),r=new this.cv.Mat,this.cv.GaussianBlur(s,r,new this.cv.Size(5,5),0),n=new this.cv.Mat,this.cv.adaptiveThreshold(r,n,255,this.cv.ADAPTIVE_THRESH_GAUSSIAN_C,this.cv.THRESH_BINARY,15,10),o=new this.cv.Mat,this.cv.cvtColor(n,o,this.cv.COLOR_GRAY2RGBA),o.convertTo(o,-1,1,10),V(o)}catch(l){return console.error("Whiteboard filter failed:",l),null}finally{_(t,s,r,n,o)}}applyBookFilter(e){let t=null,s=null,r=null,n=null,o=null;try{t=B(e),s=new this.cv.Mat,this.cv.cvtColor(t,s,this.cv.COLOR_RGBA2GRAY),r=new this.cv.Mat,this.cv.fastNlMeansDenoising(s,r,10,7,21),n=new this.cv.Mat;const l=this.cv.matFromArray(3,3,this.cv.CV_32F,[0,-1,0,-1,5,-1,0,-1,0]);return this.cv.filter2D(r,n,this.cv.CV_8U,l),l.delete(),o=new this.cv.Mat,this.cv.cvtColor(n,o,this.cv.COLOR_GRAY2RGBA),o.convertTo(o,-1,1.2,0),V(o)}catch(l){return console.error("Book filter failed:",l),null}finally{_(t,s,r,n,o)}}applyReceiptFilter(e){let t=null,s=null,r=null,n=null;try{return t=B(e),s=new this.cv.Mat,this.cv.cvtColor(t,s,this.cv.COLOR_RGBA2GRAY),r=new this.cv.Mat,this.cv.threshold(s,r,0,255,this.cv.THRESH_BINARY+this.cv.THRESH_OTSU),n=new this.cv.Mat,this.cv.cvtColor(r,n,this.cv.COLOR_GRAY2RGBA),V(n)}catch(o){return console.error("Receipt filter failed:",o),null}finally{_(t,s,r,n)}}applyPhotoFilter(e){let t=null,s=null;try{return t=B(e),s=t.clone(),s.convertTo(s,-1,1.1,5),V(s)}catch(r){return console.error("Photo filter failed:",r),null}finally{_(t,s)}}applyBlueprintFilter(e){let t=null,s=null,r=null,n=null;try{return t=B(e),s=new this.cv.Mat,this.cv.cvtColor(t,s,this.cv.COLOR_RGBA2GRAY),r=new this.cv.Mat,this.cv.bitwise_not(s,r),n=new this.cv.Mat,this.cv.cvtColor(r,n,this.cv.COLOR_GRAY2RGBA),V(n)}catch(o){return console.error("Blueprint filter failed:",o),null}finally{_(t,s,r,n)}}applyGamma(e,t){const s=new Uint8Array(256);for(let n=0;n<256;n++)s[n]=Math.pow(n/255,t)*255;const r=e.data;for(let n=0;n<r.length;n+=4)r[n]=s[r[n]],r[n+1]=s[r[n+1]],r[n+2]=s[r[n+2]]}applySaturation(e,t){const s=new this.cv.Mat;this.cv.cvtColor(e,s,this.cv.COLOR_RGBA2RGB),this.cv.cvtColor(s,s,this.cv.COLOR_RGB2HSV);const r=new this.cv.MatVector;this.cv.split(s,r);const n=r.get(1),o=1+t/100;n.convertTo(n,-1,o,0),this.cv.merge(r,s),this.cv.cvtColor(s,e,this.cv.COLOR_HSV2RGB),this.cv.cvtColor(e,e,this.cv.COLOR_RGB2RGBA),s.delete(),r.delete()}isReady(){return this.isInitialized&&fe()}}const ie=new gt,xt=(i,e)=>e.some(t=>i instanceof t);let Se,Ne;function ft(){return Se||(Se=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function pt(){return Ne||(Ne=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Oe=new WeakMap,ge=new WeakMap,Te=new WeakMap,oe=new WeakMap,pe=new WeakMap;function bt(i){const e=new Promise((t,s)=>{const r=()=>{i.removeEventListener("success",n),i.removeEventListener("error",o)},n=()=>{t(H(i.result)),r()},o=()=>{s(i.error),r()};i.addEventListener("success",n),i.addEventListener("error",o)});return e.then(t=>{t instanceof IDBCursor&&Oe.set(t,i)}).catch(()=>{}),pe.set(e,i),e}function yt(i){if(ge.has(i))return;const e=new Promise((t,s)=>{const r=()=>{i.removeEventListener("complete",n),i.removeEventListener("error",o),i.removeEventListener("abort",o)},n=()=>{t(),r()},o=()=>{s(i.error||new DOMException("AbortError","AbortError")),r()};i.addEventListener("complete",n),i.addEventListener("error",o),i.addEventListener("abort",o)});ge.set(i,e)}let xe={get(i,e,t){if(i instanceof IDBTransaction){if(e==="done")return ge.get(i);if(e==="objectStoreNames")return i.objectStoreNames||Te.get(i);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return H(i[e])},set(i,e,t){return i[e]=t,!0},has(i,e){return i instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in i}};function wt(i){xe=i(xe)}function vt(i){return i===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){const s=i.call(ce(this),e,...t);return Te.set(s,e.sort?e.sort():[e]),H(s)}:pt().includes(i)?function(...e){return i.apply(ce(this),e),H(Oe.get(this))}:function(...e){return H(i.apply(ce(this),e))}}function Ct(i){return typeof i=="function"?vt(i):(i instanceof IDBTransaction&&yt(i),xt(i,ft())?new Proxy(i,xe):i)}function H(i){if(i instanceof IDBRequest)return bt(i);if(oe.has(i))return oe.get(i);const e=Ct(i);return e!==i&&(oe.set(i,e),pe.set(e,i)),e}const ce=i=>pe.get(i);function jt(i,e,{blocked:t,upgrade:s,blocking:r,terminated:n}={}){const o=indexedDB.open(i,e),l=H(o);return s&&o.addEventListener("upgradeneeded",c=>{s(H(o.result),c.oldVersion,c.newVersion,H(o.transaction),c)}),t&&o.addEventListener("blocked",c=>t(c.oldVersion,c.newVersion,c)),l.then(c=>{n&&c.addEventListener("close",()=>n()),r&&c.addEventListener("versionchange",d=>r(d.oldVersion,d.newVersion,d))}).catch(()=>{}),l}const St=["get","getKey","getAll","getAllKeys","count"],Nt=["put","add","delete","clear"],le=new Map;function Ee(i,e){if(!(i instanceof IDBDatabase&&!(e in i)&&typeof e=="string"))return;if(le.get(e))return le.get(e);const t=e.replace(/FromIndex$/,""),s=e!==t,r=Nt.includes(t);if(!(t in(s?IDBIndex:IDBObjectStore).prototype)||!(r||St.includes(t)))return;const n=async function(o,...l){const c=this.transaction(o,r?"readwrite":"readonly");let d=c.store;return s&&(d=d.index(l.shift())),(await Promise.all([d[t](...l),r&&c.done]))[0]};return le.set(e,n),n}wt(i=>({...i,get:(e,t,s)=>Ee(e,t)||i.get(e,t,s),has:(e,t)=>!!Ee(e,t)||i.has(e,t)}));const Et="doc-scanner-db",Rt=1,M="documents",k="pages";class Dt{constructor(){A(this,"db",null)}async initialize(){this.db||(this.db=await jt(Et,Rt,{upgrade(e){if(!e.objectStoreNames.contains(M)){const t=e.createObjectStore(M,{keyPath:"id"});t.createIndex("by-created","createdAt"),t.createIndex("by-updated","updatedAt"),t.createIndex("by-name","name")}e.objectStoreNames.contains(k)||e.createObjectStore(k,{keyPath:"id"}).createIndex("by-document","documentId")}}))}async createDocument(e){if(!this.db)throw new Error("Database not initialized");const t=this.db.transaction([M,k],"readwrite");await t.objectStore(M).add(e);const s=t.objectStore(k);for(const r of e.pages)await s.add({...r,documentId:e.id});return await t.done,e}async getDocument(e){if(!this.db)throw new Error("Database not initialized");const t=await this.db.get(M,e);if(!t)return null;const s=await this.db.getAllFromIndex(k,"by-document",e);return t.pages=s.sort((r,n)=>r.pageNumber-n.pageNumber),t}async updateDocument(e){if(!this.db)throw new Error("Database not initialized");e.updatedAt=new Date;const t=this.db.transaction([M,k],"readwrite");await t.objectStore(M).put(e);const s=t.objectStore(k),r=await s.index("by-document").getAllKeys(e.id);for(const n of r)await s.delete(n);for(const n of e.pages)await s.add({...n,documentId:e.id});return await t.done,e}async deleteDocument(e){if(!this.db)throw new Error("Database not initialized");const t=this.db.transaction([M,k],"readwrite");await t.objectStore(M).delete(e);const s=t.objectStore(k),r=await s.index("by-document").getAllKeys(e);for(const n of r)await s.delete(n);await t.done}async listDocuments(e){if(!this.db)throw new Error("Database not initialized");const t=e?.sortBy||"updatedAt",s=e?.sortOrder||"desc",r=e?.limit,n=e?.offset||0;let o;t==="name"?o=await this.db.getAllFromIndex(M,"by-name"):t==="createdAt"?o=await this.db.getAllFromIndex(M,"by-created"):o=await this.db.getAllFromIndex(M,"by-updated"),s==="desc"&&o.reverse();for(const l of o){const c=await this.db.getAllFromIndex(k,"by-document",l.id);l.pages=c.sort((d,m)=>d.pageNumber-m.pageNumber)}return r!==void 0?o=o.slice(n,n+r):n>0&&(o=o.slice(n)),o}async searchDocuments(e){if(!this.db)throw new Error("Database not initialized");const t=await this.listDocuments(),s=[],r=e.toLowerCase();for(const n of t)for(const o of n.pages)if(o.ocrResult){const l=[],c=o.ocrResult.text.toLowerCase();let d=c.indexOf(r);for(;d!==-1;)l.push({text:o.ocrResult.text.substr(d,e.length),position:d}),d=c.indexOf(r,d+1);l.length>0&&s.push({documentId:n.id,pageId:o.id,matches:l})}return s}async getStorageUsage(){if(!navigator.storage||!navigator.storage.estimate)return{used:0,quota:0,percentage:0};const e=await navigator.storage.estimate(),t=e.usage||0,s=e.quota||0,r=s>0?t/s*100:0;return{used:t,quota:s,percentage:r}}async clearAll(){if(!this.db)throw new Error("Database not initialized");const e=this.db.transaction([M,k],"readwrite");await e.objectStore(M).clear(),await e.objectStore(k).clear(),await e.done}async addPage(e,t){if(!this.db)throw new Error("Database not initialized");const s=await this.getDocument(e);if(!s)throw new Error("Document not found");s.pages.push(t),s.metadata.totalPages=s.pages.length,await this.updateDocument(s)}async removePage(e,t){if(!this.db)throw new Error("Database not initialized");const s=await this.getDocument(e);if(!s)throw new Error("Document not found");s.pages=s.pages.filter(r=>r.id!==t),s.pages.forEach((r,n)=>{r.pageNumber=n+1}),s.metadata.totalPages=s.pages.length,await this.updateDocument(s)}async reorderPages(e,t){if(!this.db)throw new Error("Database not initialized");const s=await this.getDocument(e);if(!s)throw new Error("Document not found");const r=new Map(s.pages.map(n=>[n.id,n]));s.pages=t.map(n=>r.get(n)).filter(Boolean),s.pages.forEach((n,o)=>{n.pageNumber=o+1}),await this.updateDocument(s)}async exportDocument(e){if(!this.db)throw new Error("Database not initialized");const t=await this.getDocument(e);if(!t)throw new Error("Document not found");const s=JSON.stringify(t,null,2);return new Blob([s],{type:"application/json"})}async importDocument(e){if(!this.db)throw new Error("Database not initialized");const t=await e.text(),s=JSON.parse(t);return s.createdAt=new Date(s.createdAt),s.updatedAt=new Date(s.updatedAt),await this.createDocument(s),s}}let te=null;async function ne(){return te||(te=new Dt,await te.initialize()),te}const It=()=>{const i=b.useRef(null),[e,t]=b.useState(!1),[s,r]=b.useState(null),[n,o]=b.useState(!1),{currentImage:l,processedImage:c,adjustedCorners:d,selectedFilter:m,enhancementOptions:g,setCurrentView:C,setSelectedFilter:j,setEnhancementOptions:E,addDocument:h,resetScanSession:u,addToast:y}=L(p=>({currentImage:p.scanSession.currentImage,processedImage:p.scanSession.processedImage,adjustedCorners:p.scanSession.adjustedCorners,selectedFilter:p.scanSession.selectedFilter,enhancementOptions:p.scanSession.enhancementOptions,setCurrentView:p.setCurrentView,setSelectedFilter:p.setSelectedFilter,setEnhancementOptions:p.setEnhancementOptions,addDocument:p.addDocument,resetScanSession:p.resetScanSession,addToast:p.addToast}));b.useEffect(()=>{c&&!s&&(r(c),S(c))},[c]),b.useEffect(()=>{c&&F(m)},[m]),b.useEffect(()=>{s&&x(g)&&v()},[g]);const S=p=>{if(!i.current)return;const I=i.current,w=I.getContext("2d");w&&(I.width=p.width,I.height=p.height,w.putImageData(p,0,0))},F=async p=>{if(c){t(!0);try{const I=await ie.applyFilter(c,p);I?(r(I),S(I),E(se)):y({type:"error",message:"Failed to apply filter"})}catch(I){console.error("Filter application failed:",I),y({type:"error",message:"Filter application failed"})}finally{t(!1)}}},v=async()=>{if(s){t(!0);try{let p=c;if(m!=="original"&&(p=await ie.applyFilter(c,m)),!p)throw new Error("Failed to get base image");const I=await ie.enhance(p,g);I?(r(I),S(I)):y({type:"error",message:"Failed to apply adjustments"})}catch(p){console.error("Manual adjustment failed:",p)}finally{t(!1)}}},x=p=>p.brightness!==0||p.contrast!==0||p.saturation!==0||p.gamma!==1,f=p=>{j(p)},N=p=>{E(p)},D=async()=>{if(!s||!l){y({type:"error",message:"No image to save"});return}t(!0);try{const p=document.createElement("canvas"),I=p.getContext("2d");if(!I)throw new Error("Failed to get canvas context");p.width=s.width,p.height=s.height,I.putImageData(s,0,0);const w=await new Promise((X,K)=>{p.toBlob(W=>{W?X(W):K(new Error("Failed to convert canvas to blob"))},"image/png")}),R=document.createElement("canvas"),O=R.getContext("2d");if(!O)throw new Error("Failed to get canvas context");R.width=l.width,R.height=l.height,O.putImageData(l,0,0);const U=await new Promise((X,K)=>{R.toBlob(W=>{W?X(W):K(new Error("Failed to convert canvas to blob"))},"image/png")}),z=document.createElement("canvas"),G=z.getContext("2d");if(!G)throw new Error("Failed to get canvas context");const Y=300,be=Math.min(Y/s.width,Y/s.height);z.width=s.width*be,z.height=s.height*be,G.drawImage(p,0,0,z.width,z.height);const Pe=await new Promise((X,K)=>{z.toBlob(W=>{W?X(W):K(new Error("Failed to convert canvas to blob"))},"image/jpeg",.8)}),Me={id:je(),pageNumber:1,originalImage:U,processedImage:w,thumbnailImage:Pe,corners:d||[],enhancementSettings:g,filterApplied:m,dimensions:{width:s.width,height:s.height}},Z=new Date,Fe=`Document ${Z.toLocaleDateString()} ${Z.toLocaleTimeString()}`,ye={id:je(),name:Fe,createdAt:Z,updatedAt:Z,pages:[Me],tags:[],metadata:{totalPages:1,hasOCR:!1,fileSize:w.size,source:"camera"}};await(await ne()).createDocument(ye),h(ye),u(),y({type:"success",message:"Document saved successfully"}),C("documents")}catch(p){console.error("Failed to save document:",p),y({type:"error",message:"Failed to save document"})}finally{t(!1)}};return c?a.jsxs("div",{className:"flex flex-col h-full bg-gray-900",children:[a.jsxs("div",{className:"flex-1 overflow-hidden flex items-center justify-center p-4 relative",children:[a.jsx("canvas",{ref:i,className:"max-w-full max-h-full object-contain shadow-2xl"}),e&&a.jsx("div",{className:"absolute inset-0 bg-black/50 flex items-center justify-center",children:a.jsxs("div",{className:"bg-white rounded-lg p-4 flex items-center gap-3",children:[a.jsx(q,{size:"sm"}),a.jsx("span",{className:"text-sm text-gray-700",children:"Processing..."})]})})]}),a.jsx(ht,{selectedFilter:m,onSelect:f,disabled:e}),a.jsx("div",{className:"bg-white border-t border-gray-200 px-4 py-2",children:a.jsxs("button",{onClick:()=>o(!n),className:"w-full flex items-center justify-between text-sm font-medium text-gray-700 hover:text-gray-900",children:[a.jsx("span",{children:"Manual Adjustments"}),a.jsx("span",{className:"text-lg",children:n?"â–¼":"â–¶"})]})}),n&&a.jsx("div",{className:"bg-gray-50 border-t border-gray-200 max-h-80 overflow-y-auto",children:a.jsx(mt,{options:g,onChange:N,disabled:e})}),a.jsx("div",{className:"p-4 bg-white border-t border-gray-200",children:a.jsxs("div",{className:"flex gap-3",children:[a.jsx(P,{onClick:()=>C("crop"),variant:"secondary",fullWidth:!0,disabled:e,children:"Back"}),a.jsx(P,{onClick:D,variant:"primary",fullWidth:!0,disabled:e,children:"Save Document"})]})})]}):a.jsxs("div",{className:"flex flex-col items-center justify-center h-full bg-gray-50 p-6",children:[a.jsx("p",{className:"text-gray-600",children:"No image to enhance"}),a.jsx(P,{onClick:()=>C("camera"),className:"mt-4",children:"Back to Camera"})]})},Ot=()=>{const{documents:i,setDocuments:e,setCurrentDocument:t,removeDocument:s,setCurrentView:r,addToast:n}=L(h=>({documents:h.documents.list,setDocuments:h.setDocuments,setCurrentDocument:h.setCurrentDocument,removeDocument:h.removeDocument,setCurrentView:h.setCurrentView,addToast:h.addToast})),[o,l]=b.useState(!0),[c,d]=b.useState(new Map);b.useEffect(()=>{m()},[]),b.useEffect(()=>{i.length>0&&g()},[i]);const m=async()=>{try{const u=await(await ne()).listDocuments({sortBy:"updatedAt",sortOrder:"desc"});e(u)}catch(h){console.error("Failed to load documents:",h),n({type:"error",message:"Failed to load documents"})}finally{l(!1)}},g=async()=>{const h=new Map;for(const u of i)if(u.pages.length>0){const y=u.pages[0],S=URL.createObjectURL(y.thumbnailImage);h.set(u.id,S)}return d(h),()=>{c.forEach(u=>URL.revokeObjectURL(u))}},C=h=>{t(h),r("export")},j=async(h,u)=>{if(h.stopPropagation(),!!confirm("Are you sure you want to delete this document?"))try{await(await ne()).deleteDocument(u),s(u),n({type:"success",message:"Document deleted"})}catch(y){console.error("Failed to delete document:",y),n({type:"error",message:"Failed to delete document"})}},E=async(h,u)=>{h.stopPropagation(),t(u),r("ocr")};return o?a.jsx("div",{className:"flex items-center justify-center h-full bg-gray-50",children:a.jsxs("div",{className:"text-center",children:[a.jsx(q,{size:"lg"}),a.jsx("p",{className:"text-sm text-gray-600 mt-4",children:"Loading documents..."})]})}):i.length===0?a.jsxs("div",{className:"flex flex-col items-center justify-center h-full bg-gray-50 p-6",children:[a.jsx("div",{className:"text-6xl mb-4",children:"ðŸ“"}),a.jsx("h2",{className:"text-xl font-semibold mb-2",children:"No Documents Yet"}),a.jsx("p",{className:"text-sm text-gray-600 mb-6 text-center max-w-md",children:"Start by scanning your first document using the camera."}),a.jsx(P,{onClick:()=>r("camera"),variant:"primary",size:"lg",children:"Scan Document"})]}):a.jsxs("div",{className:"h-full bg-gray-50 flex flex-col",children:[a.jsxs("div",{className:"bg-white border-b border-gray-200 p-4",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("h2",{className:"text-lg font-semibold",children:"My Documents"}),a.jsx(P,{onClick:()=>r("camera"),variant:"primary",size:"sm",children:"+ New Scan"})]}),a.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:[i.length," document",i.length!==1?"s":""]})]}),a.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:a.jsx("div",{className:"grid grid-cols-2 gap-4",children:i.map(h=>a.jsxs("div",{onClick:()=>C(h),className:"bg-white rounded-lg shadow hover:shadow-lg transition-shadow cursor-pointer overflow-hidden",children:[a.jsxs("div",{className:"aspect-[3/4] bg-gray-200 relative overflow-hidden",children:[c.has(h.id)?a.jsx("img",{src:c.get(h.id),alt:h.name,className:"w-full h-full object-cover"}):a.jsx("div",{className:"w-full h-full flex items-center justify-center text-gray-400",children:a.jsx("span",{className:"text-4xl",children:"ðŸ“„"})}),a.jsx("button",{onClick:u=>j(u,h.id),className:"absolute top-2 right-2 w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center shadow-lg transition-colors",title:"Delete document",children:"Ã—"})]}),a.jsxs("div",{className:"p-3",children:[a.jsx("h3",{className:"text-sm font-medium truncate mb-1",children:h.name}),a.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500",children:[a.jsxs("span",{children:[h.pages.length," page",h.pages.length!==1?"s":""]}),a.jsx("span",{children:h.metadata.hasOCR?"âœ“ OCR":""})]}),a.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(h.updatedAt).toLocaleDateString()}),a.jsxs("div",{className:"flex gap-2 mt-2",children:[!h.metadata.hasOCR&&a.jsx("button",{onClick:u=>E(u,h),className:"flex-1 px-2 py-1 text-xs bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors",children:"Extract Text"}),a.jsx("button",{onClick:u=>{u.stopPropagation(),t(h),r("export")},className:"flex-1 px-2 py-1 text-xs bg-green-50 text-green-600 rounded hover:bg-green-100 transition-colors",children:"Export"})]})]})]},h.id))})})]})};class Tt{constructor(){A(this,"worker",null);A(this,"isInitialized",!1);A(this,"currentLanguages",["eng"])}async initialize(e=["eng"],t){if(!(this.isInitialized&&this.arraysEqual(e,this.currentLanguages))){this.worker&&await this.terminate();try{this.worker=await _e.createWorker(e.join("+"),1,{logger:s=>{t&&t({status:s.status,progress:s.progress||0})}}),this.currentLanguages=e,this.isInitialized=!0}catch(s){throw console.error("Failed to initialize OCR worker:",s),new Error("Failed to initialize OCR service")}}}async recognize(e,t){if(!this.worker||!this.isInitialized)throw new Error("OCR service not initialized");const s=performance.now();try{t&&(t.pageSegMode!==void 0&&await this.worker.setParameters({tessedit_pageseg_mode:t.pageSegMode}),t.preserveInterwordSpaces!==void 0&&await this.worker.setParameters({preserve_interword_spaces:t.preserveInterwordSpaces?"1":"0"}),t.characterWhitelist&&await this.worker.setParameters({tessedit_char_whitelist:t.characterWhitelist}),t.characterBlacklist&&await this.worker.setParameters({tessedit_char_blacklist:t.characterBlacklist}));const r=await this.worker.recognize(e),n=performance.now()-s;return this.formatResult(r.data,n)}catch(r){throw console.error("OCR recognition failed:",r),new Error("Failed to perform OCR")}}async detectOrientation(e){if(!this.worker||!this.isInitialized)throw new Error("OCR service not initialized");try{const t=await this.worker.detect(e);return{degrees:t.data.orientation_degrees||0,confidence:t.data.orientation_confidence||0,script:t.data.script||"Latin"}}catch(t){throw console.error("Orientation detection failed:",t),new Error("Failed to detect orientation")}}preprocessForOCR(e){const t=document.createElement("canvas"),s=t.getContext("2d");if(!s)throw new Error("Failed to get canvas context");t.width=e.width,t.height=e.height,s.putImageData(e,0,0);const r=e.data;for(let n=0;n<r.length;n+=4){const o=r[n]*.299+r[n+1]*.587+r[n+2]*.114;r[n]=o,r[n+1]=o,r[n+2]=o}return e}async terminate(){this.worker&&(await this.worker.terminate(),this.worker=null,this.isInitialized=!1)}formatResult(e,t){return{text:e.text,confidence:e.confidence,words:e.words.map(s=>({text:s.text,confidence:s.confidence,boundingBox:{x:s.bbox.x0,y:s.bbox.y0,width:s.bbox.x1-s.bbox.x0,height:s.bbox.y1-s.bbox.y0},baseline:{x0:s.baseline.x0,y0:s.baseline.y0,x1:s.baseline.x1,y1:s.baseline.y1}})),lines:e.lines.map(s=>({text:s.text,confidence:s.confidence,boundingBox:{x:s.bbox.x0,y:s.bbox.y0,width:s.bbox.x1-s.bbox.x0,height:s.bbox.y1-s.bbox.y0},words:s.words.map(r=>({text:r.text,confidence:r.confidence,boundingBox:{x:r.bbox.x0,y:r.bbox.y0,width:r.bbox.x1-r.bbox.x0,height:r.bbox.y1-r.bbox.y0},baseline:{x0:r.baseline.x0,y0:r.baseline.y0,x1:r.baseline.x1,y1:r.baseline.y1}}))})),paragraphs:e.paragraphs.map(s=>({text:s.text,confidence:s.confidence,boundingBox:{x:s.bbox.x0,y:s.bbox.y0,width:s.bbox.x1-s.bbox.x0,height:s.bbox.y1-s.bbox.y0},lines:s.lines.map(r=>({text:r.text,confidence:r.confidence,boundingBox:{x:r.bbox.x0,y:r.bbox.y0,width:r.bbox.x1-r.bbox.x0,height:r.bbox.y1-r.bbox.y0},words:r.words.map(n=>({text:n.text,confidence:n.confidence,boundingBox:{x:n.bbox.x0,y:n.bbox.y0,width:n.bbox.x1-n.bbox.x0,height:n.bbox.y1-n.bbox.y0},baseline:{x0:n.baseline.x0,y0:n.baseline.y0,x1:n.baseline.x1,y1:n.baseline.y1}}))}))})),blocks:(e.blocks||[]).map(s=>({text:s.text,confidence:s.confidence,boundingBox:{x:s.bbox.x0,y:s.bbox.y0,width:s.bbox.x1-s.bbox.x0,height:s.bbox.y1-s.bbox.y0},paragraphs:s.paragraphs.map(r=>({text:r.text,confidence:r.confidence,boundingBox:{x:r.bbox.x0,y:r.bbox.y0,width:r.bbox.x1-r.bbox.x0,height:r.bbox.y1-r.bbox.y0},lines:r.lines.map(n=>({text:n.text,confidence:n.confidence,boundingBox:{x:n.bbox.x0,y:n.bbox.y0,width:n.bbox.x1-n.bbox.x0,height:n.bbox.y1-n.bbox.y0},words:n.words.map(o=>({text:o.text,confidence:o.confidence,boundingBox:{x:o.bbox.x0,y:o.bbox.y0,width:o.bbox.x1-o.bbox.x0,height:o.bbox.y1-o.bbox.y0},baseline:{x0:o.baseline.x0,y0:o.baseline.y0,x1:o.baseline.x1,y1:o.baseline.y1}}))}))}))})),processingTime:t}}arraysEqual(e,t){return e.length!==t.length?!1:e.every((s,r)=>s===t[r])}}let de=null;function Pt(){return de||(de=new Tt),de}const Re=[{code:"eng",name:"English",tier:1},{code:"spa",name:"Spanish",tier:1},{code:"fra",name:"French",tier:1},{code:"deu",name:"German",tier:1},{code:"ita",name:"Italian",tier:1},{code:"por",name:"Portuguese",tier:1},{code:"rus",name:"Russian",tier:1},{code:"jpn",name:"Japanese",tier:1},{code:"chi_sim",name:"Chinese Simplified",tier:1},{code:"kor",name:"Korean",tier:1}],Mt=()=>{const{currentDocument:i,processedImage:e,isProcessing:t,progress:s,result:r,selectedLanguages:n,isInitialized:o,setOCRInitialized:l,setOCRProcessing:c,setOCRProgress:d,setOCRResult:m,setSelectedLanguages:g,setCurrentDocument:C,setDocuments:j,setCurrentView:E,addToast:h}=L(w=>({currentDocument:w.documents.currentDocument,processedImage:w.scanSession.processedImage,isProcessing:w.ocr.isProcessing,progress:w.ocr.progress,result:w.ocr.result,selectedLanguages:w.ocr.selectedLanguages,isInitialized:w.ocr.isInitialized,setOCRInitialized:w.setOCRInitialized,setOCRProcessing:w.setOCRProcessing,setOCRProgress:w.setOCRProgress,setOCRResult:w.setOCRResult,setSelectedLanguages:w.setSelectedLanguages,setCurrentDocument:w.setCurrentDocument,setDocuments:w.setDocuments,setCurrentView:w.setCurrentView,addToast:w.addToast})),[u,y]=b.useState(""),[S,F]=b.useState(!1),v=b.useRef(null),x=Pt();b.useEffect(()=>{(async()=>{if(!o)try{c(!0),await x.initialize(n,R=>{d(R.progress*100)}),l(!0),c(!1),d(0)}catch(R){console.error("Failed to initialize OCR:",R),h({type:"error",message:"Failed to initialize OCR service"}),c(!1)}})()},[]),b.useEffect(()=>{(async()=>{if(i&&i.pages.length>0&&!e)try{const R=i.pages[0],O=new Image;O.onload=()=>{const U=document.createElement("canvas"),z=U.getContext("2d");if(z){U.width=O.width,U.height=O.height,z.drawImage(O,0,0);const G=z.getImageData(0,0,O.width,O.height);if(v.current){const Y=v.current.getContext("2d");Y&&(v.current.width=G.width,v.current.height=G.height,Y.putImageData(G,0,0))}}},O.src=URL.createObjectURL(R.processedImage),R.ocrResult&&m(R.ocrResult)}catch(R){console.error("Failed to load document image:",R)}})()},[i]),b.useEffect(()=>{if(e&&v.current){const w=v.current,R=w.getContext("2d");R&&(w.width=e.width,w.height=e.height,R.putImageData(e,0,0))}},[e]),b.useEffect(()=>{r&&y(r.text)},[r]);const f=async()=>{const w=e||(i&&v.current?v.current.getContext("2d")?.getImageData(0,0,v.current.width,v.current.height):null);if(!w){h({type:"error",message:"No image to process"});return}try{c(!0),d(0);const R=await x.recognize(w,{pageSegMode:3,preserveInterwordSpaces:!0});d(100),m(R),c(!1),d(0),i&&await N(R),h({type:"success",message:`Text extracted with ${R.confidence.toFixed(1)}% confidence`})}catch(R){console.error("OCR failed:",R),h({type:"error",message:"Failed to extract text from image"}),c(!1),d(0)}},N=async w=>{if(!i){h({type:"warning",message:"No document to save OCR results to"});return}const R=w||r;if(!R){h({type:"error",message:"No OCR results to save"});return}try{const O={...i,pages:i.pages.map((G,Y)=>Y===0?{...G,ocrResult:R}:G),metadata:{...i.metadata,hasOCR:!0},updatedAt:new Date},U=await ne();await U.updateDocument(O),C(O);const z=await U.listDocuments({sortBy:"updatedAt",sortOrder:"desc"});j(z),h({type:"success",message:"OCR results saved to document"})}catch(O){console.error("Failed to save OCR results:",O),h({type:"error",message:"Failed to save OCR results"})}},D=w=>{const R=n.includes(w)?n.filter(O=>O!==w):[...n,w];if(R.length===0){h({type:"warning",message:"At least one language must be selected"});return}g(R),l(!1)},p=()=>{u&&(navigator.clipboard.writeText(u),h({type:"success",message:"Text copied to clipboard"}))},I=async()=>{if(u)if(navigator.share)try{await navigator.share({text:u,title:"Extracted Text"})}catch{}else p()};return e?a.jsxs("div",{className:"flex flex-col h-full bg-white",children:[a.jsx("div",{className:"flex-shrink-0 bg-gray-900 relative overflow-hidden",style:{height:"30%"},children:a.jsx("canvas",{ref:v,className:"absolute inset-0 w-full h-full object-contain"})}),a.jsxs("div",{className:"flex-shrink-0 bg-white border-b border-gray-200 p-3",children:[a.jsxs("div",{className:"flex items-center justify-between gap-2",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(P,{onClick:f,disabled:t||!o,variant:"primary",size:"md",children:t?"Processing...":r?"Re-scan Text":"Extract Text"}),a.jsx("button",{onClick:()=>F(!S),className:"px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",disabled:t,children:n.length===1?Re.find(w=>w.code===n[0])?.name:`${n.length} languages`})]}),r&&a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(me,{icon:"ðŸ“‹",onClick:p,title:"Copy text",size:"md"}),a.jsx(me,{icon:"ðŸ“¤",onClick:I,title:"Share text",size:"md"})]})]}),t&&a.jsxs("div",{className:"mt-3",children:[a.jsxs("div",{className:"flex items-center justify-between mb-1",children:[a.jsx("span",{className:"text-xs text-gray-600",children:s<100?"Initializing...":"Recognizing text..."}),a.jsxs("span",{className:"text-xs text-gray-600",children:[Math.round(s),"%"]})]}),a.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:a.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${s}%`}})})]}),S&&a.jsxs("div",{className:"mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200",children:[a.jsx("h3",{className:"text-sm font-medium mb-2",children:"Select Languages"}),a.jsx("div",{className:"grid grid-cols-2 gap-2",children:Re.map(w=>a.jsxs("label",{className:"flex items-center gap-2 p-2 rounded hover:bg-gray-100 cursor-pointer",children:[a.jsx("input",{type:"checkbox",checked:n.includes(w.code),onChange:()=>D(w.code),className:"rounded border-gray-300",disabled:t}),a.jsx("span",{className:"text-sm",children:w.name})]},w.code))})]}),r&&!t&&a.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:["Confidence: ",r.confidence.toFixed(1),"% â€¢ ",r.words.length," words detected"]})]}),a.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col p-4 bg-gray-50",children:[!r&&!t&&a.jsx("div",{className:"flex-1 flex items-center justify-center text-center",children:a.jsxs("div",{children:[a.jsx("div",{className:"text-4xl mb-2",children:"ðŸ”"}),a.jsx("p",{className:"text-gray-600 text-sm",children:'Click "Extract Text" to start OCR'})]})}),t&&a.jsx("div",{className:"flex-1 flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx(q,{size:"lg"}),a.jsx("p",{className:"text-sm text-gray-600 mt-4",children:"Extracting text from document..."})]})}),r&&!t&&a.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[a.jsx("label",{className:"text-sm font-medium text-gray-700 mb-2",children:"Extracted Text (editable)"}),a.jsx("textarea",{value:u,onChange:w=>y(w.target.value),className:"flex-1 w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Extracted text will appear here..."})]})]})]}):a.jsxs("div",{className:"flex flex-col items-center justify-center h-full bg-gray-50 p-6",children:[a.jsx("div",{className:"text-6xl mb-4",children:"ðŸ“„"}),a.jsx("h2",{className:"text-xl font-semibold mb-2",children:"No Image to Process"}),a.jsx("p",{className:"text-sm text-gray-600 mb-6 text-center max-w-md",children:"Capture and enhance a document first before extracting text."}),a.jsx(P,{onClick:()=>E("camera"),variant:"primary",size:"lg",children:"Go to Camera"})]})};class Ft{async exportToPDF(e,t){const s=this.getPageSize(t.pageSize),r=this.getOrientation(e,t.orientation),n=new Ve({orientation:r,unit:"mm",format:t.pageSize==="original"?[s.width,s.height]:t.pageSize});t.metadata&&(t.metadata.title&&n.setProperties({title:t.metadata.title}),t.metadata.author&&n.setProperties({author:t.metadata.author}),t.metadata.subject&&n.setProperties({subject:t.metadata.subject}));for(let o=0;o<e.pages.length;o++){const l=e.pages[o];o>0&&n.addPage();const c=await this.blobToDataURL(l.processedImage),d=n.internal.pageSize.getWidth(),m=n.internal.pageSize.getHeight();if(t.pageSize==="original"){const g=l.dimensions.width,C=l.dimensions.height,j=g/C;let E=d,h=d/j;h>m&&(h=m,E=m*j);const u=(d-E)/2,y=(m-h)/2;n.addImage(c,"JPEG",u,y,E,h)}else n.addImage(c,"JPEG",0,0,d,m);t.includeOCR&&l.ocrResult&&this.addTextLayer(n,l,d,m)}return n.output("blob")}async exportToImage(e,t){const s=document.createElement("canvas"),r=s.getContext("2d");if(!r)throw new Error("Failed to get canvas context");const n=await this.blobToImageData(e.processedImage);let o=n.width,l=n.height;if(t.maxDimension){const m=Math.max(o,l);if(m>t.maxDimension){const g=t.maxDimension/m;o=Math.round(o*g),l=Math.round(l*g)}}s.width=o,s.height=l;const c=document.createElement("canvas"),d=c.getContext("2d");if(!d)throw new Error("Failed to get temp canvas context");return c.width=n.width,c.height=n.height,d.putImageData(n,0,0),r.drawImage(c,0,0,o,l),new Promise((m,g)=>{s.toBlob(C=>{C?m(C):g(new Error("Failed to convert canvas to blob"))},t.format==="png"?"image/png":"image/jpeg",t.format==="jpeg"?t.quality/100:void 0)})}async exportMultipleImages(e,t){const s=[];for(const r of e.pages){const n=await this.exportToImage(r,t);s.push(n)}return s}async exportToText(e){const t=[];for(const r of e.pages)r.ocrResult&&t.push(`--- Page ${r.pageNumber} ---

${r.ocrResult.text}

`);if(t.length===0)throw new Error("No OCR text available in this document");const s=t.join(`
`);return new Blob([s],{type:"text/plain"})}downloadBlob(e,t){const s=URL.createObjectURL(e),r=document.createElement("a");r.href=s,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s)}async share(e,t,s){if(!navigator.share||!navigator.canShare)throw new Error("Web Share API not supported");const r=new File([e],t,{type:e.type});if(!navigator.canShare({files:[r]}))throw new Error("Cannot share this file type");await navigator.share({title:s,files:[r]})}async blobToDataURL(e){return new Promise((t,s)=>{const r=new FileReader;r.onloadend=()=>t(r.result),r.onerror=s,r.readAsDataURL(e)})}async blobToImageData(e){return new Promise((t,s)=>{const r=new Image;r.onload=()=>{const n=document.createElement("canvas"),o=n.getContext("2d");if(!o){s(new Error("Failed to get canvas context"));return}n.width=r.width,n.height=r.height,o.drawImage(r,0,0);const l=o.getImageData(0,0,r.width,r.height);t(l)},r.onerror=s,r.src=URL.createObjectURL(e)})}getPageSize(e){switch(e){case"a4":return{width:210,height:297};case"letter":return{width:216,height:279};case"legal":return{width:216,height:356};default:return{width:210,height:297}}}getOrientation(e,t){if(t!=="auto")return t;const s=e.pages[0];return s&&s.dimensions.width>s.dimensions.height?"landscape":"portrait"}addTextLayer(e,t,s,r){if(!t.ocrResult)return;const n=s/t.dimensions.width,o=r/t.dimensions.height;e.setTextColor(255,255,255),e.setFontSize(8);for(const l of t.ocrResult.words){const c=l.boundingBox.x*n,d=l.boundingBox.y*o;e.text(l.text,c,d,{renderingMode:"invisible"})}}}let ue=null;function zt(){return ue||(ue=new Ft),ue}const At=()=>{const{currentDocument:i,setCurrentView:e,addToast:t}=L(u=>({currentDocument:u.documents.currentDocument,setCurrentView:u.setCurrentView,addToast:u.addToast})),[s,r]=b.useState("pdf"),[n,o]=b.useState(!1),[l,c]=b.useState(0),[d,m]=b.useState({pageSize:"a4",orientation:"auto",quality:"high",includeOCR:!1,compression:!0}),[g,C]=b.useState({format:"png",quality:90}),j=zt(),E=async()=>{if(!i){t({type:"error",message:"No document to export"});return}o(!0),c(0);try{let u=`${i.name}`;switch(s){case"pdf":{c(30);const y=await j.exportToPDF(i,d);c(100),u+=".pdf",j.downloadBlob(y,u),t({type:"success",message:"PDF exported successfully"});break}case"png":case"jpeg":{if(i.pages.length===1){c(50);const y=await j.exportToImage(i.pages[0],{...g,format:s});c(100),u+=`.${s}`,j.downloadBlob(y,u),t({type:"success",message:`${s.toUpperCase()} exported successfully`})}else{const y=await j.exportMultipleImages(i,{...g,format:s});for(let S=0;S<y.length;S++){c((S+1)/y.length*100);const F=`${i.name}_page${S+1}.${s}`;j.downloadBlob(y[S],F)}t({type:"success",message:`${y.length} images exported successfully`})}break}case"txt":{c(50);const y=await j.exportToText(i);c(100),u+=".txt",j.downloadBlob(y,u),t({type:"success",message:"Text exported successfully"});break}}}catch(u){console.error("Export failed:",u),t({type:"error",message:u instanceof Error?u.message:"Export failed"})}finally{o(!1),c(0)}},h=async()=>{if(i){o(!0);try{let u,y;switch(s){case"pdf":u=await j.exportToPDF(i,d),y=`${i.name}.pdf`;break;case"png":case"jpeg":if(i.pages.length===1)u=await j.exportToImage(i.pages[0],{...g,format:s}),y=`${i.name}.${s}`;else{t({type:"warning",message:"Can only share single-page documents. Export multiple pages separately."});return}break;case"txt":u=await j.exportToText(i),y=`${i.name}.txt`;break;default:throw new Error("Invalid format")}await j.share(u,y,i.name),t({type:"success",message:"Shared successfully"})}catch(u){console.error("Share failed:",u),u instanceof Error&&u.message.includes("not supported")?E():t({type:"error",message:"Share failed"})}finally{o(!1)}}};return i?a.jsx("div",{className:"h-full bg-white overflow-y-auto",children:a.jsxs("div",{className:"max-w-2xl mx-auto p-6",children:[a.jsxs("div",{className:"mb-6",children:[a.jsx("h2",{className:"text-2xl font-bold mb-2",children:i.name}),a.jsxs("p",{className:"text-sm text-gray-600",children:[i.pages.length," page",i.pages.length!==1?"s":"",i.metadata.hasOCR&&" â€¢ OCR processed"]})]}),a.jsxs("div",{className:"mb-6",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-3",children:"Export Format"}),a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsxs("button",{onClick:()=>r("pdf"),className:`p-4 rounded-lg border-2 transition-all ${s==="pdf"?"border-blue-600 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,children:[a.jsx("div",{className:"text-3xl mb-2",children:"ðŸ“„"}),a.jsx("div",{className:"font-medium",children:"PDF"}),a.jsx("div",{className:"text-xs text-gray-600",children:"Multi-page document"})]}),a.jsxs("button",{onClick:()=>r("png"),className:`p-4 rounded-lg border-2 transition-all ${s==="png"?"border-blue-600 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,children:[a.jsx("div",{className:"text-3xl mb-2",children:"ðŸ–¼ï¸"}),a.jsx("div",{className:"font-medium",children:"PNG"}),a.jsx("div",{className:"text-xs text-gray-600",children:"Lossless image"})]}),a.jsxs("button",{onClick:()=>r("jpeg"),className:`p-4 rounded-lg border-2 transition-all ${s==="jpeg"?"border-blue-600 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,children:[a.jsx("div",{className:"text-3xl mb-2",children:"ðŸ“·"}),a.jsx("div",{className:"font-medium",children:"JPEG"}),a.jsx("div",{className:"text-xs text-gray-600",children:"Compressed image"})]}),a.jsxs("button",{onClick:()=>r("txt"),className:`p-4 rounded-lg border-2 transition-all ${s==="txt"?"border-blue-600 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,disabled:!i.metadata.hasOCR,children:[a.jsx("div",{className:"text-3xl mb-2",children:"ðŸ“"}),a.jsx("div",{className:"font-medium",children:"Text"}),a.jsx("div",{className:"text-xs text-gray-600",children:i.metadata.hasOCR?"OCR text only":"OCR required"})]})]})]}),s==="pdf"&&a.jsxs("div",{className:"mb-6 p-4 bg-gray-50 rounded-lg",children:[a.jsx("h3",{className:"font-medium mb-3",children:"PDF Options"}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm text-gray-700 mb-2",children:"Page Size"}),a.jsxs("select",{value:d.pageSize,onChange:u=>m({...d,pageSize:u.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[a.jsx("option",{value:"a4",children:"A4"}),a.jsx("option",{value:"letter",children:"Letter"}),a.jsx("option",{value:"legal",children:"Legal"}),a.jsx("option",{value:"original",children:"Original Size"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm text-gray-700 mb-2",children:"Orientation"}),a.jsxs("select",{value:d.orientation,onChange:u=>m({...d,orientation:u.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[a.jsx("option",{value:"auto",children:"Auto"}),a.jsx("option",{value:"portrait",children:"Portrait"}),a.jsx("option",{value:"landscape",children:"Landscape"})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm text-gray-700 mb-2",children:"Quality"}),a.jsxs("select",{value:d.quality,onChange:u=>m({...d,quality:u.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[a.jsx("option",{value:"low",children:"Low (smaller file)"}),a.jsx("option",{value:"medium",children:"Medium"}),a.jsx("option",{value:"high",children:"High"}),a.jsx("option",{value:"original",children:"Original"})]})]}),i.metadata.hasOCR&&a.jsxs("label",{className:"flex items-center gap-2",children:[a.jsx("input",{type:"checkbox",checked:d.includeOCR,onChange:u=>m({...d,includeOCR:u.target.checked}),className:"rounded border-gray-300"}),a.jsx("span",{className:"text-sm text-gray-700",children:"Include OCR text layer (searchable PDF)"})]})]})]}),(s==="png"||s==="jpeg")&&a.jsxs("div",{className:"mb-6 p-4 bg-gray-50 rounded-lg",children:[a.jsx("h3",{className:"font-medium mb-3",children:"Image Options"}),a.jsxs("div",{className:"space-y-4",children:[s==="jpeg"&&a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm text-gray-700 mb-2",children:["Quality: ",g.quality,"%"]}),a.jsx("input",{type:"range",min:"10",max:"100",step:"10",value:g.quality,onChange:u=>C({...g,quality:parseInt(u.target.value)}),className:"w-full"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"flex items-center gap-2",children:[a.jsx("input",{type:"checkbox",checked:g.maxDimension!==void 0,onChange:u=>C({...g,maxDimension:u.target.checked?2048:void 0}),className:"rounded border-gray-300"}),a.jsx("span",{className:"text-sm text-gray-700",children:"Limit maximum dimension"})]}),g.maxDimension!==void 0&&a.jsx("input",{type:"number",value:g.maxDimension,onChange:u=>C({...g,maxDimension:parseInt(u.target.value)}),className:"w-full mt-2 px-3 py-2 border border-gray-300 rounded-lg",placeholder:"Max dimension (px)"})]})]})]}),n&&a.jsxs("div",{className:"mb-6",children:[a.jsxs("div",{className:"flex items-center justify-between mb-2",children:[a.jsx("span",{className:"text-sm text-gray-600",children:"Exporting..."}),a.jsxs("span",{className:"text-sm text-gray-600",children:[Math.round(l),"%"]})]}),a.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:a.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${l}%`}})})]}),a.jsxs("div",{className:"flex gap-3",children:[a.jsx(P,{onClick:E,disabled:n,variant:"primary",size:"lg",className:"flex-1",children:n?a.jsxs("span",{className:"flex items-center justify-center gap-2",children:[a.jsx(q,{size:"sm"}),"Exporting..."]}):`Export as ${s.toUpperCase()}`}),typeof navigator.share<"u"&&a.jsx(P,{onClick:h,disabled:n,variant:"secondary",size:"lg",children:"ðŸ“¤ Share"})]})]})}):a.jsxs("div",{className:"flex flex-col items-center justify-center h-full bg-gray-50 p-6",children:[a.jsx("div",{className:"text-6xl mb-4",children:"ðŸ“¤"}),a.jsx("h2",{className:"text-xl font-semibold mb-2",children:"No Document Selected"}),a.jsx("p",{className:"text-sm text-gray-600 mb-6 text-center max-w-md",children:"Select a document from your library to export it."}),a.jsx(P,{onClick:()=>e("documents"),variant:"primary",size:"lg",children:"Go to Documents"})]})};function kt(){const i=L(t=>t.ui.currentView),e=()=>{switch(i){case"camera":return a.jsx(ve,{});case"crop":return a.jsx(ot,{});case"enhance":return a.jsx(It,{});case"documents":return a.jsx(Ot,{});case"ocr":return a.jsx(Mt,{});case"export":return a.jsx(At,{});default:return a.jsx(ve,{})}};return a.jsxs("div",{className:"flex flex-col h-screen overflow-hidden bg-white",children:[a.jsx(Xe,{}),a.jsx("main",{className:"flex-1 overflow-hidden mt-14 mb-16",children:e()}),a.jsx(Ke,{}),a.jsx(Je,{})]})}he.createRoot(document.getElementById("root")).render(a.jsx(Le.StrictMode,{children:a.jsx(kt,{})}));
