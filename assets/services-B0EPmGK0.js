var t=Object.defineProperty,e=(e,i,n)=>((e,i,n)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[i]=n)(e,"symbol"!=typeof i?i+"":i,n);import{o as i}from"./db-vendor-7JQXQzuE.js";import{J as n}from"./zip-vendor-BnyUYtAy.js";import{E as a}from"./pdf-vendor-kgbuHCKQ.js";import{s as o}from"./tesseract-vendor-C8JZVqR3.js";const r=new class{constructor(){e(this,"stream",null),e(this,"videoTrack",null),e(this,"currentFacingMode","environment")}async initialize(t){const e={facingMode:"environment",resolution:{ideal:{width:3840,height:2160},min:{width:1920,height:1080}},focusMode:"continuous",torch:!1,...t};this.currentFacingMode=e.facingMode;try{const t={video:{facingMode:{ideal:e.facingMode},width:{ideal:e.resolution.ideal.width},height:{ideal:e.resolution.ideal.height}},audio:!1};return this.stream=await navigator.mediaDevices.getUserMedia(t),this.videoTrack=this.stream.getVideoTracks()[0],this.stream}catch(i){const t={video:{facingMode:e.facingMode,width:{ideal:1920},height:{ideal:1080}},audio:!1};return this.stream=await navigator.mediaDevices.getUserMedia(t),this.videoTrack=this.stream.getVideoTracks()[0],this.stream}}getCapabilities(){if(!this.videoTrack)return null;try{const t=this.videoTrack.getCapabilities();return{hasFlash:"torch"in t,hasFocus:"focusMode"in t,hasZoom:"zoom"in t,maxZoom:t.zoom?.max||1,supportedResolutions:this.getSupportedResolutions(t)}}catch(t){return{hasFlash:!1,hasFocus:!1,hasZoom:!1,maxZoom:1,supportedResolutions:[]}}}getSupportedResolutions(t){const e=[],i=[{width:3840,height:2160},{width:1920,height:1080},{width:1280,height:720},{width:640,height:480}],n=t.width?.max||1920,a=t.height?.max||1080;for(const o of i)o.width<=n&&o.height<=a&&e.push(o);return e}async switchCamera(){const t="environment"===this.currentFacingMode?"user":"environment";return this.dispose(),this.initialize({facingMode:t})}async capturePhoto(t){if(!this.stream)throw new Error("Camera not initialized");const e=document.createElement("canvas");e.width=t.videoWidth,e.height=t.videoHeight;const i=e.getContext("2d");if(!i)throw new Error("Failed to get canvas context");return i.drawImage(t,0,0),i.getImageData(0,0,e.width,e.height)}getVideoFrame(t){if(!this.stream)return null;try{const e=document.createElement("canvas"),i=Math.min(640,t.videoWidth),n=Math.min(480,t.videoHeight);e.width=i,e.height=n;const a=e.getContext("2d");return a?(a.drawImage(t,0,0,i,n),a.getImageData(0,0,i,n)):null}catch(e){return null}}async setZoom(t){if(!this.videoTrack)throw new Error("Camera not initialized");if(!("zoom"in this.videoTrack.getCapabilities()))throw new Error("Zoom not supported");const e={advanced:[{zoom:t}]};try{await this.videoTrack.applyConstraints(e)}catch(i){throw i}}async toggleFlash(t){if(!this.videoTrack)throw new Error("Camera not initialized");if(!("torch"in this.videoTrack.getCapabilities()))throw new Error("Flash not supported");const e={advanced:[{torch:t}]};try{await this.videoTrack.applyConstraints(e)}catch(i){throw i}}async setFocusPoint(t,e){if(!this.videoTrack)throw new Error("Camera not initialized");this.videoTrack.getCapabilities()}getStream(){return this.stream}getCurrentFacingMode(){return this.currentFacingMode}isInitialized(){return null!==this.stream&&null!==this.videoTrack}dispose(){this.stream&&(this.stream.getTracks().forEach(t=>t.stop()),this.stream=null),this.videoTrack=null}};function s(){return!!window.cv}function c(){if(
/**!isLoaded ||**/
!window.cv)throw new Error("OpenCV not loaded. Call loadOpenCV() first.");return window.cv}function l(t){return c().matFromImageData(t)}function h(t){const e=c(),i=document.createElement("canvas");i.width=t.cols,i.height=t.rows;const n=i.getContext("2d");if(!n)throw new Error("Failed to get canvas context");return e.imshow(i,t),n.getImageData(0,0,i.width,i.height)}function d(...t){for(const e of t)e&&e.delete&&e.delete()}const u=new class{constructor(){e(this,"cv",null),e(this,"isInitialized",!1)}async initialize(){if(!this.isInitialized)try{this.cv=window.cv instanceof Promise?await window.cv:window.cv,this.isInitialized=!0}catch(t){throw t}}async detectDocument(t,e){this.isInitialized||await this.initialize();const i={cannyThreshold1:50,cannyThreshold2:150,blurKernelSize:5,dilationIterations:2,minAreaRatio:.1,maxAreaRatio:.95,...e};let n=null,a=null,o=null,r=null,s=null,c=null,h=null;try{n=l(t),a=new this.cv.Mat,this.cv.cvtColor(n,a,this.cv.COLOR_RGBA2GRAY),o=new this.cv.Mat;const e=new this.cv.Size(i.blurKernelSize,i.blurKernelSize);this.cv.GaussianBlur(a,o,e,0),r=new this.cv.Mat,this.cv.Canny(o,r,i.cannyThreshold1,i.cannyThreshold2),s=new this.cv.Mat;const d=this.cv.Mat.ones(3,3,this.cv.CV_8U);this.cv.dilate(r,s,d,new this.cv.Point(-1,-1),i.dilationIterations),d.delete(),c=new this.cv.MatVector,h=new this.cv.Mat,this.cv.findContours(s,c,h,this.cv.RETR_EXTERNAL,this.cv.CHAIN_APPROX_SIMPLE);return this.findBestQuadrilateral(c,t.width,t.height,i)}catch(u){return null}finally{d(n,a,o,r,s,h),c&&c.delete()}}findBestQuadrilateral(t,e,i,n){const a=e*i,o=a*n.minAreaRatio,r=a*n.maxAreaRatio;let s=null,c=0;for(let l=0;l<t.size();l++){const e=t.get(l),i=this.cv.contourArea(e);if(i<o||i>r)continue;const n=this.cv.arcLength(e,!0),h=new this.cv.Mat;if(this.cv.approxPolyDP(e,h,.02*n,!0),4===h.rows){const t=this.matToPoints(h),e=this.getBoundingRect(t),n=e.width/e.height,o=this.scoreQuadrilateral(t,i,n,a);o>c&&(c=o,s={contour:this.orderCorners(t),confidence:Math.min(o/100,1),area:i,aspectRatio:n,boundingRect:e})}h.delete()}return s}scoreQuadrilateral(t,e,i,n){let a=0;a+=50*(e/n);a+=[1,1.29,1.41,1.5].reduce((t,e)=>{const n=Math.abs(i-e),a=Math.max(0,25-20*n);return Math.max(t,a)},0);return a+=this.isRoughlyConvex(t)?25:0,a}isRoughlyConvex(t){if(4!==t.length)return!1;const e=[];for(let a=0;a<4;a++){const i=t[a],n=t[(a+1)%4],o=t[(a+2)%4],r=(n.x-i.x)*(o.y-n.y)-(n.y-i.y)*(o.x-n.x);e.push(r)}const i=e.every(t=>t>0),n=e.every(t=>t<0);return i||n}matToPoints(t){const e=[];for(let i=0;i<t.rows;i++){const n=t.data32S[2*i],a=t.data32S[2*i+1];e.push({x:n,y:a})}return e}getBoundingRect(t){const e=t.map(t=>t.x),i=t.map(t=>t.y),n=Math.min(...e),a=Math.max(...e),o=Math.min(...i);return{x:n,y:o,width:a-n,height:Math.max(...i)-o}}orderCorners(t){if(4!==t.length)return t;const e=[...t].sort((t,e)=>t.y-e.y),i=e.slice(0,2).sort((t,e)=>t.x-e.x),n=e.slice(2,4).sort((t,e)=>t.x-e.x);return[i[0],i[1],n[1],n[0]]}isReady(){return this.isInitialized&&s()}};const g=new class{async correctPerspective(t,e,i){if(!s())throw new Error("OpenCV not loaded");if(4!==e.length)throw new Error("Exactly 4 corners required");const n={outputWidth:0,outputHeight:0,preserveAspectRatio:!0,interpolation:"linear",...i};let a=null,o=null,r=null;try{const i=c();a=l(t);const s=n.outputWidth&&n.outputHeight?{width:n.outputWidth,height:n.outputHeight}:this.calculateOutputDimensions(e),d=this.ensureCornerOrder(e),u=i.matFromArray(4,1,i.CV_32FC2,[d[0].x,d[0].y,d[1].x,d[1].y,d[2].x,d[2].y,d[3].x,d[3].y]),g=i.matFromArray(4,1,i.CV_32FC2,[0,0,s.width,0,s.width,s.height,0,s.height]);r=i.getPerspectiveTransform(u,g),o=new i.Mat;const w=new i.Size(s.width,s.height),p=this.getInterpolationFlag(n.interpolation);i.warpPerspective(a,o,r,w,p,i.BORDER_CONSTANT,new i.Scalar(255,255,255,255));const m=h(o),b=this.matrixToArray(r);return u.delete(),g.delete(),{correctedImage:m,transformMatrix:b,originalCorners:d,outputDimensions:s}}catch(u){return null}finally{d(a,o,r)}}calculateOutputDimensions(t){if(4!==t.length)throw new Error("Exactly 4 corners required");const e=this.ensureCornerOrder(t),i=this.distance(e[0],e[1]),n=this.distance(e[3],e[2]),a=this.distance(e[0],e[3]),o=this.distance(e[1],e[2]),r=Math.max(i,n),s=Math.max(a,o);return{width:Math.round(r),height:Math.round(s)}}distance(t,e){const i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)}ensureCornerOrder(t){if(4!==t.length)return t;const e=t.reduce((t,e)=>t+e.x,0)/4,i=t.reduce((t,e)=>t+e.y,0)/4,n=[...t].sort((t,n)=>Math.atan2(t.y-i,t.x-e)-Math.atan2(n.y-i,n.x-e)),a=n.map(t=>t.x+t.y),o=a.indexOf(Math.min(...a));return[n[o],n[(o+1)%4],n[(o+2)%4],n[(o+3)%4]]}getInterpolationFlag(t){const e=c();switch(t){case"nearest":return e.INTER_NEAREST;case"linear":default:return e.INTER_LINEAR;case"cubic":return e.INTER_CUBIC;case"lanczos":return e.INTER_LANCZOS4}}matrixToArray(t){const e=[];for(let i=0;i<t.rows;i++){const n=[];for(let e=0;e<t.cols;e++)n.push(t.data64F[i*t.cols+e]);e.push(n)}return e}};const w=new class{constructor(){e(this,"cv",null),e(this,"isInitialized",!1)}async initialize(){if(!this.isInitialized)try{this.cv=window.cv instanceof Promise?await window.cv:window.cv,this.isInitialized=!0}catch(t){throw t}}async enhance(t,e){this.isInitialized||await this.initialize();let i=null,n=null;try{if(i=l(t),n=i.clone(),0!==e.brightness||0!==e.contrast){const t=1+e.contrast/100,i=e.brightness/100*255;n.convertTo(n,-1,t,i)}return 1!==e.gamma&&this.applyGamma(n,e.gamma),0!==e.saturation&&this.applySaturation(n,e.saturation),h(n)}catch(a){return null}finally{d(i,n)}}async applyFilter(t,e){switch(this.isInitialized||await this.initialize(),e){case"original":default:return t;case"grayscale":return this.applyGrayscale(t);case"document":return this.applyDocumentFilter(t);case"magic":return this.applyMagicFilter(t);case"whiteboard":return this.applyWhiteboardFilter(t);case"book":return this.applyBookFilter(t);case"receipt":return this.applyReceiptFilter(t);case"photo":return this.applyPhotoFilter(t);case"blueprint":return this.applyBlueprintFilter(t)}}applyGrayscale(t){let e=null,i=null,n=null;try{return e=l(t),i=new this.cv.Mat,this.cv.cvtColor(e,i,this.cv.COLOR_RGBA2GRAY),n=new this.cv.Mat,this.cv.cvtColor(i,n,this.cv.COLOR_GRAY2RGBA),n.convertTo(n,-1,1.1,5),h(n)}catch(a){return null}finally{d(e,i,n)}}applyDocumentFilter(t){let e=null,i=null,n=null,a=null,o=null;try{return e=l(t),i=new this.cv.Mat,this.cv.cvtColor(e,i,this.cv.COLOR_RGBA2GRAY),n=new this.cv.Mat,this.cv.fastNlMeansDenoising(i,n,10,7,21),a=new this.cv.Mat,this.cv.adaptiveThreshold(n,a,255,this.cv.ADAPTIVE_THRESH_GAUSSIAN_C,this.cv.THRESH_BINARY,11,2),o=new this.cv.Mat,this.cv.cvtColor(a,o,this.cv.COLOR_GRAY2RGBA),h(o)}catch(r){return null}finally{d(e,i,n,a,o)}}applyMagicFilter(t){let e=null,i=null,n=null,a=null,o=null;try{e=l(t),i=new this.cv.Mat,this.cv.cvtColor(e,i,this.cv.COLOR_RGBA2RGB),this.cv.cvtColor(i,i,this.cv.COLOR_RGB2Lab),n=new this.cv.MatVector,this.cv.split(i,n),a=n.get(0);const r=new this.cv.CLAHE(2,new this.cv.Size(8,8));return r.apply(a,a),this.cv.merge(n,i),o=new this.cv.Mat,this.cv.cvtColor(i,o,this.cv.COLOR_Lab2RGB),this.cv.cvtColor(o,o,this.cv.COLOR_RGB2RGBA),o.convertTo(o,-1,1.1,0),n.delete(),r.delete(),h(o)}catch(r){return null}finally{d(e,i,a,o)}}applyWhiteboardFilter(t){let e=null,i=null,n=null,a=null,o=null;try{return e=l(t),i=new this.cv.Mat,this.cv.cvtColor(e,i,this.cv.COLOR_RGBA2GRAY),n=new this.cv.Mat,this.cv.GaussianBlur(i,n,new this.cv.Size(5,5),0),a=new this.cv.Mat,this.cv.adaptiveThreshold(n,a,255,this.cv.ADAPTIVE_THRESH_GAUSSIAN_C,this.cv.THRESH_BINARY,15,10),o=new this.cv.Mat,this.cv.cvtColor(a,o,this.cv.COLOR_GRAY2RGBA),o.convertTo(o,-1,1,10),h(o)}catch(r){return null}finally{d(e,i,n,a,o)}}applyBookFilter(t){let e=null,i=null,n=null,a=null,o=null;try{e=l(t),i=new this.cv.Mat,this.cv.cvtColor(e,i,this.cv.COLOR_RGBA2GRAY),n=new this.cv.Mat,this.cv.fastNlMeansDenoising(i,n,10,7,21),a=new this.cv.Mat;const r=this.cv.matFromArray(3,3,this.cv.CV_32F,[0,-1,0,-1,5,-1,0,-1,0]);return this.cv.filter2D(n,a,this.cv.CV_8U,r),r.delete(),o=new this.cv.Mat,this.cv.cvtColor(a,o,this.cv.COLOR_GRAY2RGBA),o.convertTo(o,-1,1.2,0),h(o)}catch(r){return null}finally{d(e,i,n,a,o)}}applyReceiptFilter(t){let e=null,i=null,n=null,a=null;try{return e=l(t),i=new this.cv.Mat,this.cv.cvtColor(e,i,this.cv.COLOR_RGBA2GRAY),n=new this.cv.Mat,this.cv.threshold(i,n,0,255,this.cv.THRESH_BINARY+this.cv.THRESH_OTSU),a=new this.cv.Mat,this.cv.cvtColor(n,a,this.cv.COLOR_GRAY2RGBA),h(a)}catch(o){return null}finally{d(e,i,n,a)}}applyPhotoFilter(t){let e=null,i=null;try{return e=l(t),i=e.clone(),i.convertTo(i,-1,1.1,5),h(i)}catch(n){return null}finally{d(e,i)}}applyBlueprintFilter(t){let e=null,i=null,n=null,a=null;try{return e=l(t),i=new this.cv.Mat,this.cv.cvtColor(e,i,this.cv.COLOR_RGBA2GRAY),n=new this.cv.Mat,this.cv.bitwise_not(i,n),a=new this.cv.Mat,this.cv.cvtColor(n,a,this.cv.COLOR_GRAY2RGBA),h(a)}catch(o){return null}finally{d(e,i,n,a)}}applyGamma(t,e){const i=new Uint8Array(256);for(let a=0;a<256;a++)i[a]=255*Math.pow(a/255,e);const n=t.data;for(let a=0;a<n.length;a+=4)n[a]=i[n[a]],n[a+1]=i[n[a+1]],n[a+2]=i[n[a+2]]}applySaturation(t,e){const i=new this.cv.Mat;this.cv.cvtColor(t,i,this.cv.COLOR_RGBA2RGB),this.cv.cvtColor(i,i,this.cv.COLOR_RGB2HSV);const n=new this.cv.MatVector;this.cv.split(i,n);const a=n.get(1),o=1+e/100;a.convertTo(a,-1,o,0),this.cv.merge(n,i),this.cv.cvtColor(i,t,this.cv.COLOR_HSV2RGB),this.cv.cvtColor(t,t,this.cv.COLOR_RGB2RGBA),i.delete(),n.delete()}isReady(){return this.isInitialized&&s()}},p="documents",m="pages";class b{constructor(){e(this,"db",null)}async initialize(){this.db||(this.db=await i("doc-scanner-db",1,{upgrade(t){if(!t.objectStoreNames.contains(p)){const e=t.createObjectStore(p,{keyPath:"id"});e.createIndex("by-created","createdAt"),e.createIndex("by-updated","updatedAt"),e.createIndex("by-name","name")}if(!t.objectStoreNames.contains(m)){t.createObjectStore(m,{keyPath:"id"}).createIndex("by-document","documentId")}}}))}async createDocument(t){if(!this.db)throw new Error("Database not initialized");const e=this.db.transaction([p,m],"readwrite");await e.objectStore(p).add(t);const i=e.objectStore(m);for(const n of t.pages)await i.add({...n,documentId:t.id});return await e.done,t}async getDocument(t){if(!this.db)throw new Error("Database not initialized");const e=await this.db.get(p,t);if(!e)return null;const i=await this.db.getAllFromIndex(m,"by-document",t);return e.pages=i.sort((t,e)=>t.pageNumber-e.pageNumber),e}async updateDocument(t){if(!this.db)throw new Error("Database not initialized");t.updatedAt=new Date;const e=this.db.transaction([p,m],"readwrite");await e.objectStore(p).put(t);const i=e.objectStore(m),n=await i.index("by-document").getAllKeys(t.id);for(const a of n)await i.delete(a);for(const a of t.pages)await i.add({...a,documentId:t.id});return await e.done,t}async deleteDocument(t){if(!this.db)throw new Error("Database not initialized");const e=this.db.transaction([p,m],"readwrite");await e.objectStore(p).delete(t);const i=e.objectStore(m),n=await i.index("by-document").getAllKeys(t);for(const a of n)await i.delete(a);await e.done}async listDocuments(t){if(!this.db)throw new Error("Database not initialized");const e=t?.sortBy||"updatedAt",i=t?.sortOrder||"desc",n=t?.limit,a=t?.offset||0;let o;o="name"===e?await this.db.getAllFromIndex(p,"by-name"):"createdAt"===e?await this.db.getAllFromIndex(p,"by-created"):await this.db.getAllFromIndex(p,"by-updated"),"desc"===i&&o.reverse();for(const r of o){const t=await this.db.getAllFromIndex(m,"by-document",r.id);r.pages=t.sort((t,e)=>t.pageNumber-e.pageNumber)}return void 0!==n?o=o.slice(a,a+n):a>0&&(o=o.slice(a)),o}async searchDocuments(t){if(!this.db)throw new Error("Database not initialized");const e=await this.listDocuments(),i=[],n=t.toLowerCase();for(const a of e)for(const e of a.pages)if(e.ocrResult){const o=[],r=e.ocrResult.text.toLowerCase();let s=r.indexOf(n);for(;-1!==s;)o.push({text:e.ocrResult.text.substr(s,t.length),position:s}),s=r.indexOf(n,s+1);o.length>0&&i.push({documentId:a.id,pageId:e.id,matches:o})}return i}async getStorageUsage(){if(!navigator.storage||!navigator.storage.estimate)return{used:0,quota:0,percentage:0};const t=await navigator.storage.estimate(),e=t.usage||0,i=t.quota||0;return{used:e,quota:i,percentage:i>0?e/i*100:0}}async clearAll(){if(!this.db)throw new Error("Database not initialized");const t=this.db.transaction([p,m],"readwrite");await t.objectStore(p).clear(),await t.objectStore(m).clear(),await t.done}async addPage(t,e){if(!this.db)throw new Error("Database not initialized");const i=await this.getDocument(t);if(!i)throw new Error("Document not found");i.pages.push(e),i.metadata.totalPages=i.pages.length,await this.updateDocument(i)}async removePage(t,e){if(!this.db)throw new Error("Database not initialized");const i=await this.getDocument(t);if(!i)throw new Error("Document not found");i.pages=i.pages.filter(t=>t.id!==e),i.pages.forEach((t,e)=>{t.pageNumber=e+1}),i.metadata.totalPages=i.pages.length,await this.updateDocument(i)}async reorderPages(t,e){if(!this.db)throw new Error("Database not initialized");const i=await this.getDocument(t);if(!i)throw new Error("Document not found");const n=new Map(i.pages.map(t=>[t.id,t]));i.pages=e.map(t=>n.get(t)).filter(Boolean),i.pages.forEach((t,e)=>{t.pageNumber=e+1}),await this.updateDocument(i)}async exportDocument(t){if(!this.db)throw new Error("Database not initialized");const e=await this.getDocument(t);if(!e)throw new Error("Document not found");const i=JSON.stringify(e,null,2);return new Blob([i],{type:"application/json"})}async importDocument(t){if(!this.db)throw new Error("Database not initialized");const e=await t.text(),i=JSON.parse(e);return i.createdAt=new Date(i.createdAt),i.updatedAt=new Date(i.updatedAt),await this.createDocument(i),i}}let x=null;async function v(){return x||(x=new b,await x.initialize()),x}class y{async exportToPDF(t,e){const i=this.getPageSize(e.pageSize),n=this.getOrientation(t,e.orientation),o=new a({orientation:n,unit:"mm",format:"original"===e.pageSize?[i.width,i.height]:e.pageSize});e.metadata&&(e.metadata.title&&o.setProperties({title:e.metadata.title}),e.metadata.author&&o.setProperties({author:e.metadata.author}),e.metadata.subject&&o.setProperties({subject:e.metadata.subject}));for(let a=0;a<t.pages.length;a++){const i=t.pages[a];a>0&&o.addPage();const n=await this.blobToDataURL(i.processedImage),r=o.internal.pageSize.getWidth(),s=o.internal.pageSize.getHeight();if("original"===e.pageSize){const t=i.dimensions.width/i.dimensions.height;let e=r,a=r/t;a>s&&(a=s,e=s*t);const c=(r-e)/2,l=(s-a)/2;o.addImage(n,"JPEG",c,l,e,a)}else o.addImage(n,"JPEG",0,0,r,s);e.includeOCR&&i.ocrResult&&this.addTextLayer(o,i,r,s)}return o.output("blob")}async exportToImage(t,e){const i=document.createElement("canvas"),n=i.getContext("2d");if(!n)throw new Error("Failed to get canvas context");const a=await this.blobToImageData(t.processedImage);let o=a.width,r=a.height;if(e.maxDimension){const t=Math.max(o,r);if(t>e.maxDimension){const i=e.maxDimension/t;o=Math.round(o*i),r=Math.round(r*i)}}i.width=o,i.height=r;const s=document.createElement("canvas"),c=s.getContext("2d");if(!c)throw new Error("Failed to get temp canvas context");return s.width=a.width,s.height=a.height,c.putImageData(a,0,0),n.drawImage(s,0,0,o,r),new Promise((t,n)=>{i.toBlob(e=>{e?t(e):n(new Error("Failed to convert canvas to blob"))},"png"===e.format?"image/png":"image/jpeg","jpeg"===e.format?e.quality/100:void 0)})}async exportMultipleImages(t,e){const i=[];for(const n of t.pages){const t=await this.exportToImage(n,e);i.push(t)}return i}async exportToText(t,e=!1){const i=[];if(e){i.push(`# ${t.name}\n\n`),i.push(`*Created: ${new Date(t.createdAt).toLocaleDateString()}*\n\n`),i.push("---\n\n");for(const e of t.pages)e.ocrResult&&(i.push(`## Page ${e.pageNumber}\n\n`),i.push(`${e.ocrResult.text}\n\n`),e.ocrResult.confidence&&i.push(`*Confidence: ${e.ocrResult.confidence.toFixed(1)}%*\n\n`),i.push("---\n\n"))}else for(const a of t.pages)a.ocrResult&&i.push(`--- Page ${a.pageNumber} ---\n\n${a.ocrResult.text}\n\n`);if(0===i.length)throw new Error("No OCR text available in this document");const n=i.join("");return new Blob([n],{type:e?"text/markdown":"text/plain"})}downloadBlob(t,e){const i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download=e,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(i)}async share(t,e,i){if(!navigator.share||!navigator.canShare)throw new Error("Web Share API not supported");const n=new File([t],e,{type:t.type});if(!navigator.canShare({files:[n]}))throw new Error("Cannot share this file type");await navigator.share({title:i,files:[n]})}async blobToDataURL(t){return new Promise((e,i)=>{const n=new FileReader;n.onloadend=()=>e(n.result),n.onerror=i,n.readAsDataURL(t)})}async blobToImageData(t){return new Promise((e,i)=>{const n=new Image;n.onload=()=>{const t=document.createElement("canvas"),a=t.getContext("2d");if(!a)return void i(new Error("Failed to get canvas context"));t.width=n.width,t.height=n.height,a.drawImage(n,0,0);const o=a.getImageData(0,0,n.width,n.height);e(o)},n.onerror=i,n.src=URL.createObjectURL(t)})}getPageSize(t){switch(t){case"a4":default:return{width:210,height:297};case"letter":return{width:216,height:279};case"legal":return{width:216,height:356}}}getOrientation(t,e){if("auto"!==e)return e;const i=t.pages[0];return i&&i.dimensions.width>i.dimensions.height?"landscape":"portrait"}addTextLayer(t,e,i,n){if(!e.ocrResult)return;const a=i/e.dimensions.width,o=n/e.dimensions.height;t.setTextColor(255,255,255),t.setFontSize(8);for(const r of e.ocrResult.words){const e=r.boundingBox.x*a,i=r.boundingBox.y*o;t.text(r.text,e,i,{renderingMode:"invisible"})}}}let f=null;function R(){return f||(f=new y),f}class C{constructor(){e(this,"exportService",R())}async exportDocumentsAsZip(t,e,i){if(0===t.length)throw new Error("No documents selected for export");const a=new n;for(let n=0;n<t.length;n++){const o=t[n];i&&i({current:n+1,total:t.length,currentDocumentName:o.name});const r=this.sanitizeFilename(o.name);if("pdf"===e.format){const t=await this.exportService.exportToPDF(o,e.pdfOptions||this.getDefaultPDFOptions());a.file(`${r}.pdf`,t)}else{const t=await this.exportService.exportMultipleImages(o,e.imageOptions||this.getDefaultImageOptions());if(t.length>1){const i=a.folder(r);i&&t.forEach((t,n)=>{const a="jpeg"===e.imageOptions?.format?"jpg":"png";i.file(`page_${n+1}.${a}`,t)})}else if(1===t.length){const i="jpeg"===e.imageOptions?.format?"jpg":"png";a.file(`${r}.${i}`,t[0])}}}return await a.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:6}})}async exportSelectedDocuments(t,e,i,n){const a=e.filter(e=>t.includes(e.id));return this.exportDocumentsAsZip(a,i,n)}getDefaultPDFOptions(){return{pageSize:"a4",orientation:"auto",quality:"high",includeOCR:!1,compression:!0}}getDefaultImageOptions(){return{format:"png",quality:90}}sanitizeFilename(t){return t.replace(/[^a-z0-9_\-\s]/gi,"_").replace(/\s+/g,"_").substring(0,100)}generateZipFilename(t,e){return`documents_${t}_${"pdf"===e?"PDFs":"Images"}_${(new Date).toISOString().split("T")[0]}.zip`}}let O=null;function A(){return O||(O=new C),O}class M{constructor(){e(this,"worker",null),e(this,"isInitialized",!1),e(this,"currentLanguages",["eng"])}async initialize(t=["eng"],e){if(!this.isInitialized||!this.arraysEqual(t,this.currentLanguages)){this.worker&&await this.terminate();try{this.worker=await o.createWorker(t.join("+"),1,{logger:t=>{e&&e({status:t.status,progress:t.progress||0})}}),this.currentLanguages=t,this.isInitialized=!0}catch(i){throw new Error("Failed to initialize OCR service")}}}async recognize(t,e){if(!this.worker||!this.isInitialized)throw new Error("OCR service not initialized");const i=performance.now();try{e&&(void 0!==e.pageSegMode&&await this.worker.setParameters({tessedit_pageseg_mode:e.pageSegMode}),void 0!==e.preserveInterwordSpaces&&await this.worker.setParameters({preserve_interword_spaces:e.preserveInterwordSpaces?"1":"0"}),e.characterWhitelist&&await this.worker.setParameters({tessedit_char_whitelist:e.characterWhitelist}),e.characterBlacklist&&await this.worker.setParameters({tessedit_char_blacklist:e.characterBlacklist}));const n=await this.worker.recognize(t),a=performance.now()-i;return this.formatResult(n.data,a)}catch(n){throw new Error("Failed to perform OCR")}}async detectOrientation(t){if(!this.worker||!this.isInitialized)throw new Error("OCR service not initialized");try{const e=await this.worker.detect(t);return{degrees:e.data.orientation_degrees||0,confidence:e.data.orientation_confidence||0,script:e.data.script||"Latin"}}catch(e){throw new Error("Failed to detect orientation")}}preprocessForOCR(t){const e=document.createElement("canvas"),i=e.getContext("2d");if(!i)throw new Error("Failed to get canvas context");e.width=t.width,e.height=t.height,i.putImageData(t,0,0);const n=t.data;for(let a=0;a<n.length;a+=4){const t=.299*n[a]+.587*n[a+1]+.114*n[a+2];n[a]=t,n[a+1]=t,n[a+2]=t}return t}async terminate(){this.worker&&(await this.worker.terminate(),this.worker=null,this.isInitialized=!1)}formatResult(t,e){return{text:t.text,confidence:t.confidence,words:t.words.map(t=>({text:t.text,confidence:t.confidence,boundingBox:{x:t.bbox.x0,y:t.bbox.y0,width:t.bbox.x1-t.bbox.x0,height:t.bbox.y1-t.bbox.y0},baseline:{x0:t.baseline.x0,y0:t.baseline.y0,x1:t.baseline.x1,y1:t.baseline.y1}})),lines:t.lines.map(t=>({text:t.text,confidence:t.confidence,boundingBox:{x:t.bbox.x0,y:t.bbox.y0,width:t.bbox.x1-t.bbox.x0,height:t.bbox.y1-t.bbox.y0},words:t.words.map(t=>({text:t.text,confidence:t.confidence,boundingBox:{x:t.bbox.x0,y:t.bbox.y0,width:t.bbox.x1-t.bbox.x0,height:t.bbox.y1-t.bbox.y0},baseline:{x0:t.baseline.x0,y0:t.baseline.y0,x1:t.baseline.x1,y1:t.baseline.y1}}))})),paragraphs:t.paragraphs.map(t=>({text:t.text,confidence:t.confidence,boundingBox:{x:t.bbox.x0,y:t.bbox.y0,width:t.bbox.x1-t.bbox.x0,height:t.bbox.y1-t.bbox.y0},lines:t.lines.map(t=>({text:t.text,confidence:t.confidence,boundingBox:{x:t.bbox.x0,y:t.bbox.y0,width:t.bbox.x1-t.bbox.x0,height:t.bbox.y1-t.bbox.y0},words:t.words.map(t=>({text:t.text,confidence:t.confidence,boundingBox:{x:t.bbox.x0,y:t.bbox.y0,width:t.bbox.x1-t.bbox.x0,height:t.bbox.y1-t.bbox.y0},baseline:{x0:t.baseline.x0,y0:t.baseline.y0,x1:t.baseline.x1,y1:t.baseline.y1}}))}))})),blocks:(t.blocks||[]).map(t=>({text:t.text,confidence:t.confidence,boundingBox:{x:t.bbox.x0,y:t.bbox.y0,width:t.bbox.x1-t.bbox.x0,height:t.bbox.y1-t.bbox.y0},paragraphs:t.paragraphs.map(t=>({text:t.text,confidence:t.confidence,boundingBox:{x:t.bbox.x0,y:t.bbox.y0,width:t.bbox.x1-t.bbox.x0,height:t.bbox.y1-t.bbox.y0},lines:t.lines.map(t=>({text:t.text,confidence:t.confidence,boundingBox:{x:t.bbox.x0,y:t.bbox.y0,width:t.bbox.x1-t.bbox.x0,height:t.bbox.y1-t.bbox.y0},words:t.words.map(t=>({text:t.text,confidence:t.confidence,boundingBox:{x:t.bbox.x0,y:t.bbox.y0,width:t.bbox.x1-t.bbox.x0,height:t.bbox.y1-t.bbox.y0},baseline:{x0:t.baseline.x0,y0:t.baseline.y0,x1:t.baseline.x1,y1:t.baseline.y1}}))}))}))})),processingTime:e}}arraysEqual(t,e){return t.length===e.length&&t.every((t,i)=>t===e[i])}}let D=null;function E(){return D||(D=new M),D}export{A as a,R as b,r as c,E as d,u as e,v as g,w as i,g as p};
