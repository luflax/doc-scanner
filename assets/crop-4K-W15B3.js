import{r as e,j as t}from"./react-vendor-DmQDSmdE.js";import{u as s,B as n,S as r}from"./camera-BXopByFL.js";import{e as c,p as i}from"./services-B6435NxM.js";const a=({corners:s,imageSize:n,containerSize:r,onChange:c,onCommit:i,className:a=""})=>{const[o,l]=e.useState(null),[d,h]=e.useState(s),u=e.useRef(null);e.useEffect(()=>{h(s)},[s]);const f=()=>{let e,t,s=0,c=0;return n.width/n.height>r.width/r.height?(e=r.width/n.width,t=e,c=(r.height-n.height*t)/2):(t=r.height/n.height,e=t,s=(r.width-n.width*e)/2),{scaleX:e,scaleY:t,offsetX:s,offsetY:c}},g=e=>t=>{t.preventDefault(),t.stopPropagation(),l(e)},x=e=>{if(null===o)return;e.preventDefault();const t=(e=>{if(!u.current)return{x:0,y:0};const t=u.current.getBoundingClientRect();let s,n;if("touches"in e){const t=e.touches[0];s=t.clientX,n=t.clientY}else s=e.clientX,n=e.clientY;return{x:s-t.left,y:n-t.top}})(e),s=(e=>{const{scaleX:t,scaleY:s,offsetX:n,offsetY:r}=f();return{x:(e.x-n)/t,y:(e.y-r)/s}})(t),r={x:Math.max(0,Math.min(n.width,s.x)),y:Math.max(0,Math.min(n.height,s.y))},i=[...d];i[o]=r,h(i),c(i)},m=()=>{null!==o&&(l(null),i?.())},y=d.map(e=>{const{scaleX:t,scaleY:s,offsetX:n,offsetY:r}=f();return{x:e.x*t+n,y:e.y*s+r}}),p=4===y.length?`M ${y[0].x} ${y[0].y} L ${y[1].x} ${y[1].y} L ${y[2].x} ${y[2].y} L ${y[3].x} ${y[3].y} Z`:"";return t.jsxs("svg",{ref:u,className:`absolute inset-0 w-full h-full ${a}`,style:{touchAction:"none"},onMouseMove:x,onMouseUp:m,onMouseLeave:m,onTouchMove:x,onTouchEnd:m,onTouchCancel:m,children:[p&&t.jsxs(t.Fragment,{children:[t.jsx("path",{d:p,fill:"rgba(59, 130, 246, 0.2)",stroke:"none"}),t.jsx("path",{d:p,fill:"none",stroke:"#3b82f6",strokeWidth:"2"})]}),y.map((e,s)=>t.jsxs("g",{children:[t.jsx("circle",{cx:e.x,cy:e.y,r:"20",fill:"transparent",style:{cursor:"grab"},onMouseDown:g(s),onTouchStart:g(s)}),t.jsx("circle",{cx:e.x,cy:e.y,r:"8",fill:"white",stroke:"#3b82f6",strokeWidth:"3",style:{cursor:"grab",pointerEvents:"none"}}),t.jsx("circle",{cx:e.x,cy:e.y,r:"3",fill:"#3b82f6",style:{pointerEvents:"none"}})]},s)),4===y.length&&y.map((e,s)=>{const n=y[(s+1)%4];return t.jsx("line",{x1:e.x,y1:e.y,x2:n.x,y2:n.y,stroke:"#3b82f6",strokeWidth:"2",strokeDasharray:"5,5",style:{pointerEvents:"none"}},`line-${s}`)})]})},o=()=>{const o=e.useRef(null),l=e.useRef(null),[d,h]=e.useState(!1),[u,f]=e.useState(!1),[g,x]=e.useState({width:0,height:0}),{currentImage:m,detectedEdges:y,adjustedCorners:p,setCurrentView:j,resetScanSession:w,setDetectedEdges:v,setAdjustedCorners:C,setProcessedImage:S,addToast:b}=s(e=>({currentImage:e.scanSession.currentImage,detectedEdges:e.scanSession.detectedEdges,adjustedCorners:e.scanSession.adjustedCorners,setCurrentView:e.setCurrentView,resetScanSession:e.resetScanSession,setDetectedEdges:e.setDetectedEdges,setAdjustedCorners:e.setAdjustedCorners,setProcessedImage:e.setProcessedImage,addToast:e.addToast}));e.useEffect(()=>{if(m&&o.current){const e=o.current,t=e.getContext("2d");if(!t)return;e.width=m.width,e.height=m.height,t.putImageData(m,0,0)}},[m]),e.useEffect(()=>{!m||y||d||E()},[m]),e.useEffect(()=>{const e=()=>{if(l.current){const e=l.current.getBoundingClientRect();x({width:e.width,height:e.height})}};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const E=async()=>{if(m){h(!0);try{const e=await c.detectDocument(m);if(e)v(e),C(e.contour),b({type:"success",message:"Document detected!"});else{const e=[{x:0,y:0},{x:m.width,y:0},{x:m.width,y:m.height},{x:0,y:m.height}];C(e),b({type:"warning",message:"Could not detect document. Using full image."})}}catch(e){b({type:"error",message:"Edge detection failed"})}finally{h(!1)}}};return m?d?t.jsxs("div",{className:"flex flex-col items-center justify-center h-full bg-gray-900",children:[t.jsx(r,{size:"lg",className:"mb-4"}),t.jsx("p",{className:"text-white text-sm",children:"Detecting document edges..."})]}):t.jsxs("div",{className:"flex flex-col h-full bg-gray-900",children:[t.jsxs("div",{ref:l,className:"flex-1 overflow-hidden flex items-center justify-center p-4 relative",children:[t.jsx("canvas",{ref:o,className:"max-w-full max-h-full object-contain"}),p&&m&&g.width>0&&t.jsx(a,{corners:p,imageSize:{width:m.width,height:m.height},containerSize:g,onChange:e=>{C(e)}})]}),t.jsx("div",{className:"p-4 bg-white border-t border-gray-200",children:t.jsxs("div",{className:"flex gap-3",children:[t.jsx(n,{onClick:()=>{w(),j("camera")},variant:"secondary",fullWidth:!0,disabled:u,children:"Retake"}),t.jsx(n,{onClick:E,variant:"secondary",fullWidth:!0,disabled:u,children:"Auto-Detect"}),t.jsx(n,{onClick:async()=>{if(m&&p){f(!0);try{const e=await i.correctPerspective(m,p);if(!e)throw new Error("Perspective correction failed");S(e.correctedImage),j("enhance"),b({type:"success",message:"Image cropped successfully!"})}catch(e){b({type:"error",message:"Failed to crop image"})}finally{f(!1)}}},variant:"primary",fullWidth:!0,disabled:u,children:u?"Processing...":"Continue"})]})})]}):t.jsxs("div",{className:"flex flex-col items-center justify-center h-full bg-gray-50 p-6",children:[t.jsx("p",{className:"text-gray-600",children:"No image captured"}),t.jsx(n,{onClick:()=>j("camera"),className:"mt-4",children:"Back to Camera"})]})};export{o as C};
