import{r as e,j as t}from"./react-vendor-DmQDSmdE.js";import{u as s,B as a,I as r,S as i}from"./camera-BcjNYq1x.js";import{d as c,g as n}from"./services-B0EPmGK0.js";import"./vendor-DsI9Cwdy.js";import"./zustand-vendor-CAwqQeLl.js";import"./db-vendor-7JQXQzuE.js";import"./zip-vendor-BnyUYtAy.js";import"./tesseract-vendor-C8JZVqR3.js";import"./pdf-vendor-kgbuHCKQ.js";const o=[{code:"eng",name:"English",tier:1},{code:"spa",name:"Spanish",tier:1},{code:"fra",name:"French",tier:1},{code:"deu",name:"German",tier:1},{code:"ita",name:"Italian",tier:1},{code:"por",name:"Portuguese",tier:1},{code:"rus",name:"Russian",tier:1},{code:"jpn",name:"Japanese",tier:1},{code:"chi_sim",name:"Chinese Simplified",tier:1},{code:"kor",name:"Korean",tier:1}],l=()=>{const{currentDocument:l,processedImage:d,isProcessing:m,progress:g,result:x,selectedLanguages:u,isInitialized:h,setOCRInitialized:p,setOCRProcessing:f,setOCRProgress:j,setOCRResult:v,setSelectedLanguages:y,setCurrentDocument:b,setDocuments:C,setCurrentView:w,addToast:N}=s(e=>({currentDocument:e.documents.currentDocument,processedImage:e.scanSession.processedImage,isProcessing:e.ocr.isProcessing,progress:e.ocr.progress,result:e.ocr.result,selectedLanguages:e.ocr.selectedLanguages,isInitialized:e.ocr.isInitialized,setOCRInitialized:e.setOCRInitialized,setOCRProcessing:e.setOCRProcessing,setOCRProgress:e.setOCRProgress,setOCRResult:e.setOCRResult,setSelectedLanguages:e.setSelectedLanguages,setCurrentDocument:e.setCurrentDocument,setDocuments:e.setDocuments,setCurrentView:e.setCurrentView,addToast:e.addToast})),[R,I]=e.useState(""),[O,z]=e.useState(!1),D=e.useRef(null),S=c();e.useEffect(()=>{(async()=>{if(!h)try{f(!0),await S.initialize(u,e=>{j(100*e.progress)}),p(!0),f(!1),j(0)}catch(e){N({type:"error",message:"Failed to initialize OCR service"}),f(!1)}})()},[]),e.useEffect(()=>{(async()=>{if(l&&l.pages.length>0&&!d)try{const e=l.pages[0],t=new Image;t.onload=()=>{const e=document.createElement("canvas"),s=e.getContext("2d");if(s){e.width=t.width,e.height=t.height,s.drawImage(t,0,0);const a=s.getImageData(0,0,t.width,t.height);if(D.current){const e=D.current.getContext("2d");e&&(D.current.width=a.width,D.current.height=a.height,e.putImageData(a,0,0))}}},t.src=URL.createObjectURL(e.processedImage),e.ocrResult&&v(e.ocrResult)}catch(e){}})()},[l]),e.useEffect(()=>{if(d&&D.current){const e=D.current,t=e.getContext("2d");t&&(e.width=d.width,e.height=d.height,t.putImageData(d,0,0))}},[d]),e.useEffect(()=>{x&&I(x.text)},[x]);const E=async e=>{if(!l)return void N({type:"warning",message:"No document to save OCR results to"});const t=e||x;if(t)try{const e={...l,pages:l.pages.map((e,s)=>0===s?{...e,ocrResult:t}:e),metadata:{...l.metadata,hasOCR:!0},updatedAt:new Date},s=await n();await s.updateDocument(e),b(e);const a=await s.listDocuments({sortBy:"updatedAt",sortOrder:"desc"});C(a),N({type:"success",message:"OCR results saved to document"})}catch(s){N({type:"error",message:"Failed to save OCR results"})}else N({type:"error",message:"No OCR results to save"})},P=()=>{R&&(navigator.clipboard.writeText(R),N({type:"success",message:"Text copied to clipboard"}))};return d?t.jsxs("div",{className:"flex flex-col h-full bg-white",children:[t.jsx("div",{className:"flex-shrink-0 bg-gray-900 relative overflow-hidden",style:{height:"30%"},children:t.jsx("canvas",{ref:D,className:"absolute inset-0 w-full h-full object-contain"})}),t.jsxs("div",{className:"flex-shrink-0 bg-white border-b border-gray-200 p-3",children:[t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(a,{onClick:async()=>{const e=d||(l&&D.current?D.current.getContext("2d")?.getImageData(0,0,D.current.width,D.current.height):null);if(e)try{f(!0),j(0);const t=await S.recognize(e,{pageSegMode:3,preserveInterwordSpaces:!0});j(100),v(t),f(!1),j(0),l&&await E(t),N({type:"success",message:`Text extracted with ${t.confidence.toFixed(1)}% confidence`})}catch(t){N({type:"error",message:"Failed to extract text from image"}),f(!1),j(0)}else N({type:"error",message:"No image to process"})},disabled:m||!h,variant:"primary",size:"md",children:m?"Processing...":x?"Re-scan Text":"Extract Text"}),t.jsx("button",{onClick:()=>z(!O),className:"px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",disabled:m,children:1===u.length?o.find(e=>e.code===u[0])?.name:`${u.length} languages`})]}),x&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(r,{icon:"ðŸ“‹",onClick:P,title:"Copy text",size:"md"}),t.jsx(r,{icon:"ðŸ“¤",onClick:async()=>{if(R)if(navigator.share)try{await navigator.share({text:R,title:"Extracted Text"})}catch(e){}else P()},title:"Share text",size:"md"})]})]}),m&&t.jsxs("div",{className:"mt-3",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1",children:[t.jsx("span",{className:"text-xs text-gray-600",children:g<100?"Initializing...":"Recognizing text..."}),t.jsxs("span",{className:"text-xs text-gray-600",children:[Math.round(g),"%"]})]}),t.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:t.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${g}%`}})})]}),O&&t.jsxs("div",{className:"mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200",children:[t.jsx("h3",{className:"text-sm font-medium mb-2",children:"Select Languages"}),t.jsx("div",{className:"grid grid-cols-2 gap-2",children:o.map(e=>t.jsxs("label",{className:"flex items-center gap-2 p-2 rounded hover:bg-gray-100 cursor-pointer",children:[t.jsx("input",{type:"checkbox",checked:u.includes(e.code),onChange:()=>(e=>{const t=u.includes(e)?u.filter(t=>t!==e):[...u,e];0!==t.length?(y(t),p(!1)):N({type:"warning",message:"At least one language must be selected"})})(e.code),className:"rounded border-gray-300",disabled:m}),t.jsx("span",{className:"text-sm",children:e.name})]},e.code))})]}),x&&!m&&t.jsxs("div",{className:"mt-2 text-xs text-gray-600",children:["Confidence: ",x.confidence.toFixed(1),"% â€¢ ",x.words.length," words detected"]})]}),t.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col p-4 bg-gray-50",children:[!x&&!m&&t.jsx("div",{className:"flex-1 flex items-center justify-center text-center",children:t.jsxs("div",{children:[t.jsx("div",{className:"text-4xl mb-2",children:"ðŸ”"}),t.jsx("p",{className:"text-gray-600 text-sm",children:'Click "Extract Text" to start OCR'})]})}),m&&t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx(i,{size:"lg"}),t.jsx("p",{className:"text-sm text-gray-600 mt-4",children:"Extracting text from document..."})]})}),x&&!m&&t.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[t.jsx("label",{className:"text-sm font-medium text-gray-700 mb-2",children:"Extracted Text (editable)"}),t.jsx("textarea",{value:R,onChange:e=>I(e.target.value),className:"flex-1 w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Extracted text will appear here..."})]})]})]}):t.jsxs("div",{className:"flex flex-col items-center justify-center h-full bg-gray-50 p-6",children:[t.jsx("div",{className:"text-6xl mb-4",children:"ðŸ“„"}),t.jsx("h2",{className:"text-xl font-semibold mb-2",children:"No Image to Process"}),t.jsx("p",{className:"text-sm text-gray-600 mb-6 text-center max-w-md",children:"Capture and enhance a document first before extracting text."}),t.jsx(a,{onClick:()=>w("camera"),variant:"primary",size:"lg",children:"Go to Camera"})]})};export{l as OCRView};
