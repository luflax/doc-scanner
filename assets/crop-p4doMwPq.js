import{r as e,j as t}from"./react-vendor-DmQDSmdE.js";import{u as s,B as r,S as n}from"./camera-BcjNYq1x.js";import{e as i,p as c}from"./services-B0EPmGK0.js";import"./vendor-DsI9Cwdy.js";import"./zustand-vendor-CAwqQeLl.js";import"./db-vendor-7JQXQzuE.js";import"./zip-vendor-BnyUYtAy.js";import"./tesseract-vendor-C8JZVqR3.js";import"./pdf-vendor-kgbuHCKQ.js";const a=({corners:s,imageSize:r,containerSize:n,onChange:i,onCommit:c,className:a=""})=>{const[o,l]=e.useState(null),[d,h]=e.useState(s),u=e.useRef(null);e.useEffect(()=>{h(s)},[s]);const f=()=>{let e,t,s=0,i=0;return r.width/r.height>n.width/n.height?(e=n.width/r.width,t=e,i=(n.height-r.height*t)/2):(t=n.height/r.height,e=t,s=(n.width-r.width*e)/2),{scaleX:e,scaleY:t,offsetX:s,offsetY:i}},g=e=>t=>{t.preventDefault(),t.stopPropagation(),l(e)},m=e=>{if(null===o)return;e.preventDefault();const t=(e=>{if(!u.current)return{x:0,y:0};const t=u.current.getBoundingClientRect();let s,r;if("touches"in e){const t=e.touches[0];s=t.clientX,r=t.clientY}else s=e.clientX,r=e.clientY;return{x:s-t.left,y:r-t.top}})(e),s=(e=>{const{scaleX:t,scaleY:s,offsetX:r,offsetY:n}=f();return{x:(e.x-r)/t,y:(e.y-n)/s}})(t),n={x:Math.max(0,Math.min(r.width,s.x)),y:Math.max(0,Math.min(r.height,s.y))},c=[...d];c[o]=n,h(c),i(c)},x=()=>{null!==o&&(l(null),c?.())},y=d.map(e=>{const{scaleX:t,scaleY:s,offsetX:r,offsetY:n}=f();return{x:e.x*t+r,y:e.y*s+n}}),p=4===y.length?`M ${y[0].x} ${y[0].y} L ${y[1].x} ${y[1].y} L ${y[2].x} ${y[2].y} L ${y[3].x} ${y[3].y} Z`:"";return t.jsxs("svg",{ref:u,className:`absolute inset-0 w-full h-full ${a}`,style:{touchAction:"none"},onMouseMove:m,onMouseUp:x,onMouseLeave:x,onTouchMove:m,onTouchEnd:x,onTouchCancel:x,children:[p&&t.jsxs(t.Fragment,{children:[t.jsx("path",{d:p,fill:"rgba(59, 130, 246, 0.2)",stroke:"none"}),t.jsx("path",{d:p,fill:"none",stroke:"#3b82f6",strokeWidth:"2"})]}),y.map((e,s)=>t.jsxs("g",{children:[t.jsx("circle",{cx:e.x,cy:e.y,r:"20",fill:"transparent",style:{cursor:"grab"},onMouseDown:g(s),onTouchStart:g(s)}),t.jsx("circle",{cx:e.x,cy:e.y,r:"8",fill:"white",stroke:"#3b82f6",strokeWidth:"3",style:{cursor:"grab",pointerEvents:"none"}}),t.jsx("circle",{cx:e.x,cy:e.y,r:"3",fill:"#3b82f6",style:{pointerEvents:"none"}})]},s)),4===y.length&&y.map((e,s)=>{const r=y[(s+1)%4];return t.jsx("line",{x1:e.x,y1:e.y,x2:r.x,y2:r.y,stroke:"#3b82f6",strokeWidth:"2",strokeDasharray:"5,5",style:{pointerEvents:"none"}},`line-${s}`)})]})},o=()=>{const o=e.useRef(null),l=e.useRef(null),[d,h]=e.useState(!1),[u,f]=e.useState(!1),[g,m]=e.useState({width:0,height:0}),{currentImage:x,detectedEdges:y,adjustedCorners:p,setCurrentView:j,resetScanSession:w,setDetectedEdges:v,setAdjustedCorners:C,setProcessedImage:b,addToast:S}=s(e=>({currentImage:e.scanSession.currentImage,detectedEdges:e.scanSession.detectedEdges,adjustedCorners:e.scanSession.adjustedCorners,setCurrentView:e.setCurrentView,resetScanSession:e.resetScanSession,setDetectedEdges:e.setDetectedEdges,setAdjustedCorners:e.setAdjustedCorners,setProcessedImage:e.setProcessedImage,addToast:e.addToast}));e.useEffect(()=>{if(x&&o.current){const e=o.current,t=e.getContext("2d");if(!t)return;e.width=x.width,e.height=x.height,t.putImageData(x,0,0)}},[x]),e.useEffect(()=>{!x||y||d||E()},[x]),e.useEffect(()=>{const e=()=>{if(l.current){const e=l.current.getBoundingClientRect();m({width:e.width,height:e.height})}};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const E=async()=>{if(x){h(!0);try{const e=await i.detectDocument(x);if(e)v(e),C(e.contour),S({type:"success",message:"Document detected!"});else{const e=[{x:0,y:0},{x:x.width,y:0},{x:x.width,y:x.height},{x:0,y:x.height}];C(e),S({type:"warning",message:"Could not detect document. Using full image."})}}catch(e){S({type:"error",message:"Edge detection failed"})}finally{h(!1)}}};return x?d?t.jsxs("div",{className:"flex flex-col items-center justify-center h-full bg-gray-900",children:[t.jsx(n,{size:"lg",className:"mb-4"}),t.jsx("p",{className:"text-white text-sm",children:"Detecting document edges..."})]}):t.jsxs("div",{className:"flex flex-col h-full bg-gray-900",children:[t.jsxs("div",{ref:l,className:"flex-1 overflow-hidden flex items-center justify-center p-4 relative",children:[t.jsx("canvas",{ref:o,className:"max-w-full max-h-full object-contain"}),p&&x&&g.width>0&&t.jsx(a,{corners:p,imageSize:{width:x.width,height:x.height},containerSize:g,onChange:e=>{C(e)}})]}),t.jsx("div",{className:"p-4 bg-white border-t border-gray-200",children:t.jsxs("div",{className:"flex gap-3",children:[t.jsx(r,{onClick:()=>{w(),j("camera")},variant:"secondary",fullWidth:!0,disabled:u,children:"Retake"}),t.jsx(r,{onClick:E,variant:"secondary",fullWidth:!0,disabled:u,children:"Auto-Detect"}),t.jsx(r,{onClick:async()=>{if(x&&p){f(!0);try{const e=await c.correctPerspective(x,p);if(!e)throw new Error("Perspective correction failed");b(e.correctedImage),j("enhance"),S({type:"success",message:"Image cropped successfully!"})}catch(e){S({type:"error",message:"Failed to crop image"})}finally{f(!1)}}},variant:"primary",fullWidth:!0,disabled:u,children:u?"Processing...":"Continue"})]})})]}):t.jsxs("div",{className:"flex flex-col items-center justify-center h-full bg-gray-50 p-6",children:[t.jsx("p",{className:"text-gray-600",children:"No image captured"}),t.jsx(r,{onClick:()=>j("camera"),className:"mt-4",children:"Back to Camera"})]})};export{o as CropView};
